<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registro de Detenidos - Completo</title>

<!-- Librer√≠as necesarias -->
<script src="./jszip.min.js"></script>
<script src="./FileSaver.min.js"></script>
<script src="xlsx.full.min.js"></script>

<!-- Plantillas Base64 (debes tener estos archivos que definen window.PLANTILLAS con las claves necesarias) -->
<script src="./plantilla_amarillas.js"></script>
<script src="./plantilla_azules.js"></script>
<script src="./plantilla_derechos_espanol.js"></script>
<script src="./plantilla_derechos_ingles.js"></script>
<script src="./plantilla_derechos_arabe.js"></script>
<script src="./plantilla_derechos_italiano.js"></script>
<script src="./plantilla_derechos_ruso.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #222;
    color: #eee;
    margin: 0; padding: 20px;
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }
  form {
    max-width: 900px;
    margin: 0 auto;
    background: #333;
    padding: 20px;
    border-radius: 10px;
  }
  .grid-rows {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 15px;
  }
  label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }
  input, select, textarea {
    width: 100%;
    padding: 6px;
    border-radius: 5px;
    border: none;
    font-size: 14px;
  }
  textarea {
    resize: vertical;
    min-height: 60px;
  }
  button {
    margin-top: 20px;
    padding: 12px 20px;
    font-weight: bold;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #btnDescargar { background: #004080; color: white; }
  #btnDescargarZip { background: #228B22; color: white; margin-left: 10px; }
  #message {
    margin-top: 15px;
    font-weight: bold;
    text-align: center;
  }
</style>
</head>
<body>

<h1>Registro de Detenidos - Completo</h1>

<form id="registroForm" autocomplete="off">

  <div class="grid-rows">

    <!-- Datos personales -->
    <div>
      <label for="Nombre">Nombre</label>
      <input type="text" id="Nombre" name="Nombre" required />
    </div>
    <div>
      <label for="APELLIDOS">Apellidos</label>
      <input type="text" id="APELLIDOS" name="APELLIDOS" required />
    </div>
    <div>
      <label for="TIPO_DOCUMENTO_OPCION">Tipo Documento</label>
      <select id="TIPO_DOCUMENTO_OPCION" name="TIPO_DOCUMENTO_OPCION" required>
        <option value="DNI">DNI</option>
        <option value="PASAPORTE">Pasaporte</option>
        <option value="OTRO">Otro</option>
        <option value="INDOCUMENTADO/A">Indocumentado/a</option>
      </select>
    </div>
    <div>
      <label for="TIPO_DOCUMENTO">Especifique si Otro</label>
      <input type="text" id="TIPO_DOCUMENTO" name="TIPO_DOCUMENTO" />
    </div>
    <div>
      <label for="N_DOCUMENTO">N√∫mero Documento</label>
      <input type="text" id="N_DOCUMENTO" name="N_DOCUMENTO" />
    </div>
    <div>
      <label for="SEXO_OPCION">Sexo</label>
      <select id="SEXO_OPCION" name="SEXO_OPCION" required>
        <option value="M">Masculino</option>
        <option value="F">Femenino</option>
        <option value="OTRO">Otro</option>
      </select>
    </div>
    <div>
      <label for="NACIONALIDAD">Nacionalidad</label>
      <input type="text" id="NACIONALIDAD" name="NACIONALIDAD" />
    </div>
    <div>
      <label for="FECHA_NACIMIENTO">Fecha de Nacimiento (dd/mm/aaaa)</label>
      <input type="text" id="FECHA_NACIMIENTO" name="FECHA_NACIMIENTO" placeholder="dd/mm/aaaa" />
    </div>

    <!-- Domicilio y tel√©fono -->
    <div>
      <label for="DOMICILIO_OPCION">Domicilio</label>
      <select id="DOMICILIO_OPCION" name="DOMICILIO_OPCION">
        <option value="DOMICILIO1">Domicilio 1</option>
        <option value="DOMICILIO2">Domicilio 2</option>
        <option value="OTRO">Otro</option>
      </select>
    </div>
    <div>
      <label for="DOMICILIO">Especifique si Otro</label>
      <input type="text" id="DOMICILIO" name="DOMICILIO" />
    </div>
    <div>
      <label for="TELEFONO_OPCION">Tel√©fono</label>
      <select id="TELEFONO_OPCION" name="TELEFONO_OPCION">
        <option value="TEL1">Tel√©fono 1</option>
        <option value="TEL2">Tel√©fono 2</option>
        <option value="OTRO">Otro</option>
      </select>
    </div>
    <div>
      <label for="TELEFONO">Especifique si Otro</label>
      <input type="text" id="TELEFONO" name="TELEFONO" />
    </div>

    <!-- Datos hechos -->
    <div>
      <label for="LUGAR_HECHO">Lugar del Hecho</label>
      <input type="text" id="LUGAR_HECHO" name="LUGAR_HECHO" />
    </div>
    <div>
      <label for="HORA_HECHO">Hora del Hecho (HH:MM)</label>
      <input type="time" id="HORA_HECHO" name="HORA_HECHO" />
    </div>
    <div>
      <label for="LUGAR_DETENCION">Lugar de la Detenci√≥n</label>
      <input type="text" id="LUGAR_DETENCION" name="LUGAR_DETENCION" />
    </div>
    <div>
      <label for="HORA_DETENCION">Hora de la Detenci√≥n (HH:MM)</label>
      <input type="time" id="HORA_DETENCION" name="HORA_DETENCION" />
    </div>
    <div style="grid-column: span 3;">
      <label for="BREVE_RESUMEN_HECHOS">Breve Resumen de los Hechos</label>
      <textarea id="BREVE_RESUMEN_HECHOS" name="BREVE_RESUMEN_HECHOS"></textarea>
    </div>
    <div style="grid-column: span 3;">
      <label for="INDICIOS_DETENCION">Indicios por los que se detiene</label>
      <textarea id="INDICIOS_DETENCION" name="INDICIOS_DETENCION"></textarea>
    </div>

    <!-- Datos derechos -->
    <div>
      <label for="ABOGADO_OPCION">Abogado</label>
      <select id="ABOGADO_OPCION" name="ABOGADO_OPCION">
        <option value="NO">No</option>
        <option value="SI">S√≠</option>
        <option value="OTRO">Otro</option>
      </select>
    </div>
    <div>
      <label for="ABOGADO">Especifique si Otro</label>
      <input type="text" id="ABOGADO" name="ABOGADO" />
    </div>
    <div>
      <label for="COMUNICARSE_CON_OPCION">Comunicarse con</label>
      <select id="COMUNICARSE_CON_OPCION" name="COMUNICARSE_CON_OPCION">
        <option value="FAMILIA">Familia</option>
        <option value="AMIGO">Amigo</option>
        <option value="OTRO">Otro</option>
      </select>
    </div>
    <div>
      <label for="COMUNICARSE_CON">Especifique si Otro</label>
      <input type="text" id="COMUNICARSE_CON" name="COMUNICARSE_CON" />
    </div>
    <div>
      <label for="INFORMAR_DE_SU_DETENCION_OPCION">Informar de su detenci√≥n</label>
      <select id="INFORMAR_DE_SU_DETENCION_OPCION" name="INFORMAR_DE_SU_DETENCION_OPCION">
        <option value="NO">No</option>
        <option value="SI">S√≠</option>
        <option value="OTRO">Otro</option>
      </select>
    </div>
    <div>
      <label for="INFORMAR_DE_SU_DETENCION">Especifique si Otro</label>
      <input type="text" id="INFORMAR_DE_SU_DETENCION" name="INFORMAR_DE_SU_DETENCION" />
    </div>

    <!-- Int√©rprete -->
    <div>
      <label for="INTERPRETE_OPCION">Int√©rprete</label>
      <select id="INTERPRETE_OPCION" name="INTERPRETE_OPCION">
        <option value="NO">No</option>
        <option value="INGLES">Ingl√©s</option>
        <option value="ARABE">√Årabe</option>
        <option value="ITALIANO">Italiano</option>
        <option value="RUSO">Ruso</option>
        <option value="OTRO">Otro</option>
      </select>
    </div>
    <div>
      <label for="IDIOMA">Idioma si Otro</label>
      <input type="text" id="IDIOMA" name="IDIOMA" />
    </div>

    <!-- Fecha generaci√≥n -->
    <div>
      <label for="FECHA_GENERACION">Fecha de generaci√≥n</label>
      <input type="date" id="FECHA_GENERACION" name="FECHA_GENERACION" value="" />
    </div>

  </div>

  <div style="text-align:center;">
    <button type="button" id="btnDescargar" onclick="generarXLSX()">üíæ Descargar Excel</button>
    <button type="button" id="btnDescargarZip" onclick="generarZip()">üì¶ Descargar ZIP Completo</button>
  </div>

  <div id="message"></div>
</form>

<script>
  // Variables globales
  // Aqu√≠ puedes agregar delitos elegidos si tienes l√≥gica para ello
  let delitosElegidos = [];

  // Escapa texto para XML
  function xmlEscape(str) {
    if (!str) return "";
    return str.replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&apos;");
  }

  // Construye regex flexible para reemplazo en XML (ignora espacios y saltos)
  function buildFlexibleRegex(key) {
    const escaped = key.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    const flexible = escaped.split('').join('[\\s\\n\\r]*');
    return new RegExp(flexible, 'gi');
  }

  // Normaliza texto para Excel y archivos
  function U(text) {
    if (!text) return "";
    return text.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
  }

  // Sanitiza texto para nombre de archivo
  function sanitizeForFilename(text) {
    if (!text) return "archivo";
    return text.replace(/[^a-z0-9]/gi, '_').toLowerCase();
  }

  // Guarda Blob con FileSaver.js
  function saveBlob(blob, filename) {
    saveAs(blob, filename);
  }

  // Genera Excel con todos los datos
  function generarXLSX() {
    const msg = document.getElementById("message");
    msg.innerText = "Generando Excel...";

    const form = document.getElementById("registroForm");
    const fd = new FormData(form);
    const data = {};
    fd.forEach((v,k) => data[k] = v);

    // Construir filas con todos los campos importantes
    const filas = [
      ["Campo", "Valor"],
      ["Nombre", U(data["Nombre"])],
      ["Apellidos", U(data["APELLIDOS"])],
      ["Tipo Documento", U(data["TIPO_DOCUMENTO_OPCION"])],
      ["Especifique Tipo Documento", U(data["TIPO_DOCUMENTO"])],
      ["N√∫mero Documento", U(data["N_DOCUMENTO"])],
      ["Sexo", U(data["SEXO_OPCION"])],
      ["Nacionalidad", U(data["NACIONALIDAD"])],
      ["Fecha de Nacimiento", U(data["FECHA_NACIMIENTO"])],
      ["Domicilio", (data["DOMICILIO_OPCION"] === "OTRO") ? U(data["DOMICILIO"]) : U(data["DOMICILIO_OPCION"])],
      ["Tel√©fono", (data["TELEFONO_OPCION"] === "OTRO") ? U(data["TELEFONO"]) : U(data["TELEFONO_OPCION"])],
      ["Lugar del Hecho", U(data["LUGAR_HECHO"])],
      ["Hora del Hecho", data["HORA_HECHO"]],
      ["Lugar de la Detenci√≥n", U(data["LUGAR_DETENCION"])],
      ["Hora de la Detenci√≥n", data["HORA_DETENCION"]],
      ["Breve Resumen de los Hechos", U(data["BREVE_RESUMEN_HECHOS"])],
      ["Indicios por los que se detiene", U(data["INDICIOS_DETENCION"])],
      ["Abogado", (data["ABOGADO_OPCION"] === "OTRO") ? U(data["ABOGADO"]) : U(data["ABOGADO_OPCION"])],
      ["Comunicarse con", (data["COMUNICARSE_CON_OPCION"] === "OTRO") ? U(data["COMUNICARSE_CON"]) : U(data["COMUNICARSE_CON_OPCION"])],
      ["Informar de su detenci√≥n", (data["INFORMAR_DE_SU_DETENCION_OPCION"] === "OTRO") ? U(data["INFORMAR_DE_SU_DETENCION"]) : U(data["INFORMAR_DE_SU_DETENCION_OPCION"])],
      ["Int√©rprete", U(data["INTERPRETE_OPCION"])],
      ["Idioma si Otro", U(data["IDIOMA"])],
      ["Fecha de generaci√≥n", data["FECHA_GENERACION"]],
    ];

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(filas);
    XLSX.utils.book_append_sheet(wb, ws, "Datos");
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    const blob = new Blob([wbout], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
    const filename = `${sanitizeForFilename(data["Nombre"]||"")}_${sanitizeForFilename(data["APELLIDOS"]||"")}_registro.xlsx`;
    saveBlob(blob, filename);
    msg.innerText = "‚úÖ Excel generado y descargado";
  }

  // Genera ZIP con Excel y ODTs
  async function generarZip() {
    const msg = document.getElementById("message");
    msg.innerText = "Generando ZIP con Excel y ODT...";

    try {
      const form = document.getElementById("registroForm");
      const fd = new FormData(form);
      const data = {};
      fd.forEach((v,k) => data[k] = v);

      // Normalizaciones
      const optTD = data["TIPO_DOCUMENTO_OPCION"];
      data["TIPO_DOCUMENTO"] = (optTD === "OTRO") ? (data["TIPO_DOCUMENTO"] || "") : optTD;
      if(optTD === "INDOCUMENTADO/A"){ data["N_DOCUMENTO"] = ""; } else { data["N_DOCUMENTO"] = data["N_DOCUMENTO"] || ""; }
      data["SEXO"] = data["SEXO_OPCION"] || "";
      data["FECHA_GENERACION"] = data["FECHA_GENERACION"] || "";

      // Construir filas para Excel
      const filas = [
        ["Campo", "Valor"],
        ["Nombre", U(data["Nombre"])],
        ["Apellidos", U(data["APELLIDOS"])],
        ["Tipo Documento", U(data["TIPO_DOCUMENTO"])],
        ["N√∫mero Documento", U(data["N_DOCUMENTO"])],
        ["Sexo", U(data["SEXO"])],
        ["Nacionalidad", U(data["NACIONALIDAD"])],
        ["Fecha de Nacimiento", U(data["FECHA_NACIMIENTO"])],
        ["Domicilio", (data["DOMICILIO_OPCION"] === "OTRO") ? U(data["DOMICILIO"]) : U(data["DOMICILIO_OPCION"])],
        ["Tel√©fono", (data["TELEFONO_OPCION"] === "OTRO") ? U(data["TELEFONO"]) : U(data["TELEFONO_OPCION"])],
        ["Lugar del Hecho", U(data["LUGAR_HECHO"])],
        ["Hora del Hecho", data["HORA_HECHO"]],
        ["Lugar de la Detenci√≥n", U(data["LUGAR_DETENCION"])],
        ["Hora de la Detenci√≥n", data["HORA_DETENCION"]],
        ["Breve Resumen de los Hechos", U(data["BREVE_RESUMEN_HECHOS"])],
        ["Indicios por los que se detiene", U(data["INDICIOS_DETENCION"])],
        ["Abogado", (data["ABOGADO_OPCION"] === "OTRO") ? U(data["ABOGADO"]) : U(data["ABOGADO_OPCION"])],
        ["Comunicarse con", (data["COMUNICARSE_CON_OPCION"] === "OTRO") ? U(data["COMUNICARSE_CON"]) : U(data["COMUNICARSE_CON_OPCION"])],
        ["Informar de su detenci√≥n", (data["INFORMAR_DE_SU_DETENCION_OPCION"] === "OTRO") ? U(data["INFORMAR_DE_SU_DETENCION"]) : U(data["INFORMAR_DE_SU_DETENCION_OPCION"])],
        ["Int√©rprete", U(data["INTERPRETE_OPCION"])],
        ["Idioma si Otro", U(data["IDIOMA"])],
        ["Fecha de generaci√≥n", data["FECHA_GENERACION"]],
      ];

      // Crear libro y hoja con XLSX.js
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(filas);
      ws['!cols'] = [{wch:40}, {wch:60}];
      XLSX.utils.book_append_sheet(wb, ws, "Resumen");
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const excelBlob = new Blob([wbout], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});

      // Crear ZIP con JSZip
      const zip = new JSZip();

      // A√±adir Excel
      const nombreArchivoExcel = `${sanitizeForFilename(data["Nombre"]||"")}_${sanitizeForFilename(data["APELLIDOS"]||"")}_${new Date().toISOString().slice(0,10)}.xlsx`;
      zip.file(nombreArchivoExcel, excelBlob);

      // Funci√≥n para generar ODT desde plantilla base64 y datos
      async function generarODT(plantillaBase64, datos) {
        const binaryString = atob(plantillaBase64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        const odtZip = new JSZip();
        const zipContent = await odtZip.loadAsync(bytes);
        let contentXml = await zipContent.file("content.xml").async("string");
        for (const key in datos) {
          const regex = buildFlexibleRegex(key);
          contentXml = contentXml.replace(regex, xmlEscape(datos[key] || ""));
        }
        zipContent.file("content.xml", contentXml);
        return zipContent.generateAsync({type:"uint8array"});
      }

      // Datos para plantillas (incluye hechos, derechos, domicilio, tel√©fono)
      const datosPlantilla = {
        "NOMBRE": data["Nombre"] || "",
        "APELLIDOS": data["APELLIDOS"] || "",
        "TIPO_DOCUMENTO": data["TIPO_DOCUMENTO"] || "",
        "N_DOCUMENTO": data["N_DOCUMENTO"] || "",
        "SEXO": data["SEXO"] || "",
        "NACIONALIDAD": data["NACIONALIDAD"] || "",
        "FECHA_NACIMIENTO": data["FECHA_NACIMIENTO"] || "",
        "DOMICILIO": (data["DOMICILIO_OPCION"] === "OTRO") ? data["DOMICILIO"] : data["DOMICILIO_OPCION"],
        "TELEFONO": (data["TELEFONO_OPCION"] === "OTRO") ? data["TELEFONO"] : data["TELEFONO_OPCION"],
        "LUGAR_HECHO": data["LUGAR_HECHO"] || "",
        "HORA_HECHO": data["HORA_HECHO"] || "",
        "LUGAR_DETENCION": data["LUGAR_DETENCION"] || "",
        "HORA_DETENCION": data["HORA_DETENCION"] || "",
        "BREVE_RESUMEN_HECHOS": data["BREVE_RESUMEN_HECHOS"] || "",
        "INDICIOS_DETENCION": data["INDICIOS_DETENCION"] || "",
        "ABOGADO": (data["ABOGADO_OPCION"] === "OTRO") ? data["ABOGADO"] : data["ABOGADO_OPCION"],
        "COMUNICARSE_CON": (data["COMUNICARSE_CON_OPCION"] === "OTRO") ? data["COMUNICARSE_CON"] : data["COMUNICARSE_CON_OPCION"],
        "INFORMAR_DE_SU_DETENCION": (data["INFORMAR_DE_SU_DETENCION_OPCION"] === "OTRO") ? data["INFORMAR_DE_SU_DETENCION"] : data["INFORMAR_DE_SU_DETENCION_OPCION"],
        "INTERPRETE": data["INTERPRETE_OPCION"] || "NO",
        "IDIOMA": data["IDIOMA"] || "",
        "FECHA_GENERACION": data["FECHA_GENERACION"] || "",
      };

      // A√±adir plantilla derechos espa√±ol siempre
      if(window.PLANTILLAS && window.PLANTILLAS.derechos_espanol){
        const odtDerechos = await generarODT(window.PLANTILLAS.derechos_espanol, datosPlantilla);
        zip.file("Derechos_Espanol.odt", odtDerechos);
      }

      // Elegir plantilla derechos seg√∫n int√©rprete
      let idiomaPlantilla = datosPlantilla.INTERPRETE.toLowerCase();
      if(idiomaPlantilla === "otro") {
        idiomaPlantilla = datosPlantilla.IDIOMA.toLowerCase();
      }
      const plantillaDerechosKey = `derechos_${idiomaPlantilla}`;
      if(idiomaPlantilla && window.PLANTILLAS && window.PLANTILLAS[plantillaDerechosKey]){
        const odtIdioma = await generarODT(window.PLANTILLAS[plantillaDerechosKey], datosPlantilla);
        zip.file(`Derechos_${idiomaPlantilla.charAt(0).toUpperCase() + idiomaPlantilla.slice(1)}.odt`, odtIdioma);
      }

      // Determinar edad para plantilla amarilla o azul
      let esMayorEdad = false;
      if(data["FECHA_NACIMIENTO"]){
        const parts = data["FECHA_NACIMIENTO"].split("/");
        if(parts.length === 3){
          const fechaNac = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
          const hoy = new Date();
          let edad = hoy.getFullYear() - fechaNac.getFullYear();
          const m = hoy.getMonth() - fechaNac.getMonth();
          if(m < 0 || (m === 0 && hoy.getDate() < fechaNac.getDate())){
            edad--;
          }
          esMayorEdad = edad >= 18;
        }
      }

      // A√±adir plantilla amarillas o azules
      if(esMayorEdad && window.PLANTILLAS && window.PLANTILLAS.amarillas){
        const odtAmarillas = await generarODT(window.PLANTILLAS.amarillas, datosPlantilla);
        zip.file("Plantilla_Amarillas.odt", odtAmarillas);
      } else if(!esMayorEdad && window.PLANTILLAS && window.PLANTILLAS.azules){
        const odtAzules = await generarODT(window.PLANTILLAS.azules, datosPlantilla);
        zip.file("Plantilla_Azules.odt", odtAzules);
      }

      // Generar ZIP y descargar
      const zipContent = await zip.generateAsync({type:"blob"});
      const nombreZip = `${sanitizeForFilename(data["Nombre"]||"")}_${sanitizeForFilename(data["APELLIDOS"]||"")}_Documentos_${new Date().toISOString().slice(0,10)}.zip`;
      saveBlob(zipContent, nombreZip);

      msg.innerText = "‚úÖ ZIP generado y descargado";
    } catch (err) {
      console.error(err);
      msg.innerText = "‚ùå Error al generar ZIP: " + (err?.message || err);
    }
  }
</script>

</body>
</html>
