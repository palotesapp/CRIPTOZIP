<!DOCTYPE html>
<html lang="es">
<head>

<link rel="icon" href="favicon.png" sizes="512x512">
<link rel="apple-touch-icon" href="favicon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Registro Detenidos">
	
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Registro de Detenidos - Formato Completo Offline</title>

<!-- Librerías necesarias -->
<script src="./jszip.min.js"></script>
<script src="./FileSaver.min.js"></script>
<script src="xlsx.full.min.js"></script>

<!-- Plantillas Base64: deben definir window.PLANTILLAS con claves:
     { amarillas, azules, fax, derechos_ingles, derechos_espanol } -->
<script src="./plantilla_amarillas.js"></script>
<script src="./plantilla_azules.js"></script>
<script src="./plantilla_fax.js"></script>
<script src="./plantilla_derechos_ingles.js"></script>
<script src="./plantilla_derechos_espanol.js"></script>
<script src="./plantilla_derechos_arabe.js"></script>
<script src="./plantilla_derechos_italiano.js"></script>
<script src="./plantilla_derechos_ruso.js"></script>
<style>
  :root { --primary:#3498db; --hover:#2980b9; --panel:rgba(0,0,0,0.75); --text:#fff; --field-bg:rgba(255,255,255,0.9); --border:#aaa; --radius:12px; --space:16px; --card-pad:14px; }
  *{box-sizing:border-box}
  body{margin:0;padding:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:url('fondo.jpg') no-repeat center center fixed;background-size:cover;min-height:100vh;display:flex;flex-direction:column;justify-content:center;}
  h1{text-align:center;margin:16px 0 20px;font-size:32px;font-weight:800;color:#fff;text-transform:uppercase;text-shadow:2px 2px 8px rgba(0,0,0,.7);}
  form{background:var(--panel);color:var(--text);border-radius:var(--radius);max-width:1400px;margin:0 auto 32px;padding:28px 32px;box-shadow:0 10px 28px rgba(0,0,0,.6);}
  h2{font-size:20px;text-transform:uppercase;margin-top:28px;margin-bottom:12px;border-bottom:2px solid var(--primary);padding-bottom:6px;letter-spacing:.5px;}
  .grid-rows{display:grid;grid-gap:var(--space);grid-template-columns: repeat(3, minmax(280px,1fr));}
  @media(max-width:1200px){.grid-rows{grid-template-columns:repeat(2,minmax(280px,1fr));}}
  @media(max-width:700px){.grid-rows{grid-template-columns:1fr;}}
  .field-card{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.18);border-radius:10px;padding:var(--card-pad);display:flex;flex-direction:column;gap:8px;min-height:94px;}
  label{font-weight:700;font-size:12px;margin-bottom:2px;text-transform:uppercase;letter-spacing:.6px;}
  input,select,textarea{width:100%;padding:5px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--field-bg);color:#000;}
  textarea{resize:vertical;min-height:56px;}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(52,152,219,.25);}
  .actions{text-align:center;margin-top:26px;}
  button{color:#fff;padding:14px 26px;border:none;border-radius:10px;font-weight:800;font-size:15px;text-transform:uppercase;cursor:pointer;letter-spacing:.6px;display:block;width:100%;margin-bottom:20px;}
  button:hover{opacity:0.9;}
  #message{margin-top:12px;text-align:center;font-weight:bold;color:#fff;}
  .full-width {
    grid-column: span 3;
  }
  /* Reduce la altura por defecto de todas las tarjetas */
  .field-card {
    padding: 10px;        /* antes var(--card-pad)=14px */
    gap: 6px;             /* antes 8px */
    min-height: 64px;     /* antes 94px */
  }
  textarea {
    min-height: 34px;     /* altura visible del textarea */
  }

  /* Ajuste responsivo para que en móvil los campos de "Hechos" vayan en columna */
  .grid-rows {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
  }

  .grid-rows .field-card {
    flex: 1;
    min-width: 200px; /* así en pantallas grandes aún se ve en fila */
  }

  @media (max-width: 768px) {
    .grid-rows {
      flex-direction: column;   /* <--- fuerza apilado vertical */
    }
    .grid-rows .field-card {
      width: 100% !important;
      min-width: unset !important;
    }
  }

  input[type="time"] {
    width: 100px;   /* lo justo para HH:MM con espacio delante y detrás */
    text-align: center; /* centra el valor dentro del campo */
  }

  .field-card input[type="time"] {
    width: 100px !important;   /* fuerza anchura justa */
    text-align: center;        /* centra HH:MM */
    display: inline-block;     /* evita que se estire */
  }

  .field-card.small-width {
    max-width: 160px !important; /* fuerza el ancho del globo */
    flex: 0 0 160px !important;  /* no dejar que el flex de .grid-rows lo estire */
  }
  .field-card.small-width input[type="time"] {
    width: 100%; 
    text-align: center;
  }

  /* Botones colores específicos */
  #btnDescargar { background: #003366; } /* azul oscuro */
  #btnCargar { background: #006400; } /* verde */
  #btnRefrescar { background: #1E90FF; } /* azul */

  #delitoOtroTexto::placeholder {
  color: #ff0000; /* Cambia #ff0000 por el color que quieras */
  opacity: 1;
}

	 h2 {
  font-family: 'Comic Sans MS', sans-serif;
  font-size: 120%;
  font-weight: bold;
  color: darkcyan; /* si quieres mantener el color darkcyan */
}
	 #marca-registro {
  position: fixed;
  bottom: 5px;
  right: 5px;
  font-size: 10px;
  color: rgba(255, 0, 0, 0.5); /* rojo con 50% de opacidad */
  pointer-events: none;
  user-select: none;
  z-index: 9999;
  font-family: Arial, sans-serif;
  text-align: center; /* para centrar las líneas */
  line-height: 1.2; /* espacio entre líneas */
}
</style>

</head>
<body>
  <h1>Registro de Detenidos</h1>

  <form id="registroForm" autocomplete="off">
    <h2>Datos de Filiación</h2>
    <div class="grid-rows">
      <div class="field-card" style="color: lightblue;">
        <label>Tipo Documento</label>
        <select name="TIPO DOCUMENTO_OPCION" id="tipoDocumento">
          <option value="INDOCUMENTADO/A" selected>INDOCUMENTADO/A</option>
          <option value="DNI">DNI</option>
          <option value="NIE">NIE</option>
          <option value="PASAPORTE">PASAPORTE</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="TIPO DOCUMENTO" id="tipoDocumentoOtro" placeholder="Especificar otro" style="display:none;">
      </div>
      <div class="field-card" style="color: lightblue;">
        <label>Nº Documento</label>
        <input type="text" name="NºDOCUMENTO" id="numeroDocumento">
      </div>
      <div class="field-card" style="color: lightblue;">
        <label>Sexo</label>
        <select name="SEXO_OPCION" id="sexoOpcion">
          <option value="MASCULINO" selected>MASCULINO</option>
          <option value="FEMENINO">FEMENINO</option>
        </select>
      </div>
      <div class="field-card" style="color: lightblue;"><label>Nacionalidad</label><input type="text" name="NACIONALIDAD" id="nacionalidadtexto" placeholder="País"></div>
      <div class="field-card" style="color: lightblue;"><label>Nombre</label><input type="text" name="Nombre" id="Nombre"></div>
      <div class="field-card" style="color: lightblue;"><label>Apellidos</label><input type="text" name="APELLIDOS" id="APELLIDOS"></div>
      <div class="field-card" style="color: lightblue;">
        <label>Nombre de los Padres</label>
        <select name="NOMBRE_PADRES_OPCION" id="nombrePadresOpcion">
          <option value="NO APORTA" selected>NO APORTA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="NOMBRE_PADRES" id="nombrePadresTexto" placeholder="Especificar" style="display:none;">
      </div>
      <div class="field-card" style="color: lightblue;"><label>Fecha de nacimiento</label><input type="text" name="FECHA DE NACIMIENTO" placeholder="DD/MM/AAAA"></div>
      <div class="field-card" style="color: lightblue;"><label>Lugar de nacimiento</label><input type="text" name="LUGAR DE NACIMIENTO"></div>
      <div class="field-card" style="color: lightblue;">
        <label>Domicilio</label>
        <select name="DOMICILIO_OPCION" id="domicilioOpcion">
          <option value="NO APORTA" selected>NO APORTA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="DOMICILIO" maxlength="45" id="domicilioTexto" placeholder="Especificar" style="display:none;">
      </div>
      <div class="field-card" style="color: lightblue;">
        <label>Teléfono</label>
        <select name="TELÉFONO_OPCION" id="telefonoOpcion">
          <option value="NO APORTA" selected>NO APORTA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="TELÉFONO" id="telefonoTexto" placeholder="Especificar" style="display:none;">
      </div>
      <div class="field-card" style="color: red;"><label>Fecha actual por defecto</label><input type="text" name="FECHA_GENERACION" id="fechaGeneracion"></div>
    </div>

    <h2>Hechos</h2>
    <div class="grid-rows">
      <div class="field-card" style="color: green;">
        <label>Delito(s)</label>
        <select id="delitoSelect">
          <option value="">-- Seleccionar --</option>
          <option value="HURTO">HURTO</option>
          <option value="DAÑOS">DAÑOS</option>
          <option value="ESTAFA">ESTAFA</option>
          <option value="ROBO CON FUERZA">ROBO CON FUERZA</option>
          <option value="ROBO USO DE VEHICULO">ROBO USO DE VEHÍCULO</option>
          <option value="HURTO USO DE VEHICULO">HURTO USO DE VEHÍCULO</option>
          <option value="ROBO CON VIOLENCIA">ROBO CON VIOLENCIA</option>
          <option value="LESIONES">LESIONES</option>
          <option value="AMENAZAS GRAVES">AMENAZAS GRAVES</option>
          <option value="MALOS TRATOS EN EL ÁMBITO FAMILIAR">MALOS TRATOS EN EL ÁMBITO FAMILIAR</option>
          <option value="ABUSO SEXUAL">ABUSO SEXUAL</option>
          <option value="ATENTADO AGENTE AUTORIDAD">ATENTADO AGENTE AUTORIDAD</option>
          <option value="DESOBEDIENCIA">DESOBEDIENCIA</option>
          <option value="CONTRA LA SEGURIDAD VIAL">CONTRA LA SEGURIDAD VIAL</option>
          <option value="CONTRA LA SALUD PÚBLICA">CONTRA LA SALUD PÚBLICA</option>
          <option value="TRÁFICO DE DROGAS">TRÁFICO DE DROGAS</option>
          <option value="FALSEDAD DOCUMENTAL">FALSEDAD DOCUMENTAL</option>
          <option value="RECLAMACIÓN JUDICIAL">RECLAMACIÓN JUDICIAL</option>
          <option value="QUEBRANTAMIENTO DE CONDENA">QUEBRANTAMIENTO DE CONDENA</option>
          <option value="OTRO">OTRO</option>
        </select>

        <!-- input para OTRO -->
        <input type="text" id="delitoOtroTexto" placeholder="Especificar y pulsar Enter" style="display:none;">

        <!-- sub-globo inferior -->
        <div id="delitosSeleccionados" style="margin-top:8px; padding:5px; border:1px solid #ccc; min-height:30px;">
          <em>Ningún delito seleccionado</em>
        </div>
      </div>
      <div class="field-card" style="color: lightgreen;"><label>Indicativo</label><input type="text" name="Indicativo" id="indicativotexto" placeholder="A-000"></div>
      <div class="field-card" style="color: lightgreen;"><label>C.P. Agentes</label><input type="text" name="C.P. AGENTES" id="agentestexto"></div>
      <div class="field-card" style="color: lightgreen;"><label>Diligencias</label><input type="text" name="DILIGENCIAS" id="diligenciatexto" placeholder="Pedir a GTD/ODAC ☏"></div>
      <div class="field-card" style="color: lightgreen;"><label>Instructor</label><input type="number" name="INSTRUCTOR" id="instructortexto" placeholder="Pedir a GTD/ODAC ☏"></div>
      <div class="field-card" style="color: lightgreen;"><label>Lugar del hecho</label><input type="text" name="LUGAR DEL HECHO"></div>
      <div class="field-card" style="color: lightgreen;"><label>Lugar de la detención</label><input type="text" name="LUGAR DE LA DETENCIÓN"></div>
      <div class="field-card" style="color: lightgreen;"><label>Hora del hecho</label><input type="time" name="HORA DEL HECHO" id="horaHecho"></div>
      <div class="field-card" style="color: lightgreen;"><label>Hora de la detención</label><input type="time" name="HORA DE LA DETENCIÓN" id="horaDetencion"></div>
      <div class="field-card full-width" style="color: lightgreen;">
        <label>Breve resumen de los hechos</label><textarea name="BREVE RESUMEN DE LOS HECHOS" id="brevetexto" placeholder="Ej: Autor de agresión con arma blanca..."></textarea>
      </div>

      <div class="field-card full-width" style="color: lightgreen;">
        <label>Indicios por los que se detiene</label><textarea name="INDICIOS POR LOS QUE SE DETIENE" id="indiciostexto" placeholder="Ej: Manifestaciones perjudicado, testigos..."></textarea>
      </div>
    </div>
    <h2>Derechos</h2>
    <div class="grid-rows">
      <div class="field-card" style="color: orange;">
        <label>Abogado</label>
        <select name="ABOGADO_OPCION" id="abogadoOpcion">
          <option value="DE OFICIO" selected>DE OFICIO</option>
          <option value="OTRO">PARTICULAR</option>
        </select>
        <input type="text" name="ABOGADO" id="abogadoTexto" placeholder="Nombre y teléfono" style="display:none;">
      </div>
      <div class="field-card" style="color: orange;">
        <label>Comunicarse con</label>
        <select name="COMUNICARSE CON_OPCION" id="comunicarseOpcion">
          <option value="NADIE" selected>NADIE</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="COMUNICARSE CON:" id="comunicarseTexto" placeholder="Nombre y teléfono" style="display:none;">
      </div>
      <div class="field-card" style="color: orange;">
        <label>Informar de su detención a:</label>
        <select name="INFORMAR DE SU DETENCION_OPCION" id="informardeOpcion">
          <option value="NADIE" selected>NADIE</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="INFORMAR DE SU DETENCION:" id="informardeTexto" placeholder="Nombre y teléfono" style="display:none;">
      </div>

      <div class="field-card" style="color: orange;">
        <label>Intérprete</label>
        <select name="INTERPRETE_OPCION" id="interpreteOpcion">
          <option value="NO" selected>NO</option>
          <option value="INGLÉS">INGLÉS</option>
          <option value="ÁRABE">ÁRABE</option>
          <option value="ITALIANO">ITALIANO</option>
          <option value="RUSO">RUSO</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="IDIOMA" id="idioma" placeholder="Especificar idioma/contexto" style="display:none;">
      </div>
      <div class="field-card" style="color: orange;">
        <label>Médico</label>
        <select name="MEDICO" id="medico">
          <option value="NO" selected>NO</option>
          <option value="SI">SI</option>
        </select>
      </div>
      <div class="field-card" style="color: orange;">
        <label>Consulado</label>
        <select name="CONSULADO" id="consulado">
          <option value="NO" selected>NO</option>
          <option value="SI">SI</option>
        </select>
      </div>
    </div>
        <div class="actions">
      <input type="file" id="fileInputXLSX" accept=".xlsx" style="display:none">

      <!-- Descarga XLSX (igual que antes) -->
      <button type="button" id="btnDescargar" onclick="generarXLSX()">
        💾 Descarga
      </button>

      <!-- ZIP con XLSX + ODTs -->
      <button type="button" id="btnDescargarZip" onclick="generarZIP()" style="background:#66cdaa;">
        📦 ZIP (Excel y Formularios)
      </button>

      <button type="button" id="btnCargar" onclick="cargarExcel()">
        🗂️ Carga
      </button>

      <button type="button" id="btnRefrescar" onclick="location.reload();">
        🔄 Refrescar
      </button>
    </div>

    <div id="message"></div>
  </form>

<script>
/* ===== Helpers placeholders ===== */
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"); }
function buildFlexibleRegex(key){
  const chars = key.split("").map(c=>escapeRegExp(c));
  const flexible = chars.join("(?:\\s|<[^>]+>|&nbsp;)*");
  return new RegExp("\\{\\{(?:\\s|<[^>]+>|&nbsp;)*"+flexible+"(?:\\s|<[^>]+>|&nbsp;)*\\}\\}","gi");
}
function xmlEscape(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Rellena ODT con valores */
async function odtConDatos(odtBase64, map) {
  if (!odtBase64) return odtBase64;
  const zipIn = await JSZip.loadAsync(String(odtBase64).replace(/^data:.*?;base64,/, ""), { base64: true });
  const contentFile = zipIn.file("content.xml");
  if (!contentFile) return odtBase64;
  let xml = await contentFile.async("string");
  for (const [key, val] of Object.entries(map)) {
    const re = buildFlexibleRegex(key);
    xml = xml.replace(re, xmlEscape(val ?? ""));
  }
  zipIn.file("content.xml", xml);
  return await zipIn.generateAsync({ type: "base64" });
}

/* Construye mapa de placeholders coherente con XLSX */
function construirMapaPlaceholders(data, interpreteDisplay, horas) {
  return {
    "Nombre": data["Nombre"] || "",
    "Apellidos": data["APELLIDOS"] || "",
    "Tipo de documento": data["TIPO DOCUMENTO"] || "",
    "Nº Documento": data["NºDOCUMENTO"] || "",
    "NºDOCUMENTO": data["NºDOCUMENTO"] || "",
    "Sexo": data["SEXO"] || "",
    "Nacionalidad": data["NACIONALIDAD"] || "",
    "Nombre de los Padres": data["NOMBRE_PADRES"] || data["Nombre de los Padres"] || "",
    "Fecha de nacimiento": data["FECHA DE NACIMIENTO"] || "",
    "Lugar de nacimiento": data["LUGAR DE NACIMIENTO"] || "",
    "Domicilio": data["DOMICILIO"] || "",
    "Teléfono": data["TELÉFONO"] || "",
    "Delito": data["DELITO"] || "",
    "C.P. Agentes": data["C.P. AGENTES"] || "",
    "CP AGENTES": data["C.P. AGENTES"] || "",
    "Diligencias": data["DILIGENCIAS"] || "",
    "Instructor": data["INSTRUCTOR"] || "",
    "Lugar del hecho": data["LUGAR DEL HECHO"] || data["LUGAR DE HECHO"] || "",
    "Lugar de la detención": data["LUGAR DE LA DETENCIÓN"] || "",
    "Hora del hecho": horas.hHecho || "",
    "Hora de la detención": horas.hDet || "",
    "Breve resumen de los hechos": data["BREVE RESUMEN DE LOS HECHOS"] || "",
    "Indicios por los que se detiene": data["INDICIOS POR LOS QUE SE DETIENE"] || "",
    "Abogado": data["ABOGADO"] || "",
    "Comunicarse con": data["COMUNICARSE CON:"] || "",
    "Informar de su detención": data["INFORMAR DE SU DETENCION"] || "",
    "Intérprete": interpreteDisplay || "",
    "Médico": data["MEDICO"] || "",
    "Consulado": data["CONSULADO"] || "",
    "Indicativo": data["Indicativo"] || "",
    "Fecha de generación": data["FECHA_GENERACION"] || ""
  };
}
</script>

<script>
// --- Generar ZIP con XLSX + ODTs ---
async function generarZIP() {
  const msg = document.getElementById("message");
  msg.innerText = "Generando ZIP...";

  try {
    const form = document.getElementById("registroForm");
    const fd = new FormData(form);
    const data = {}; fd.forEach((v,k)=>data[k]=v);

    // === normalizaciones (igual que ya tenías) ===
    const optTD = data["TIPO DOCUMENTO_OPCION"];
    data["TIPO DOCUMENTO"] = (optTD === "OTRO") ? (data["TIPO DOCUMENTO"]||"") : optTD;
    if (optTD === "INDOCUMENTADO/A") data["NºDOCUMENTO"] = "";
    data["SEXO"] = data["SEXO_OPCION"] || "";
    data["INSTRUCTOR"] = data["INSTRUCTOR"] || "";
    data["FECHA_GENERACION"] = document.getElementById('fechaGeneracion')?.value || "";

    let delitoTexto = "";
    if (Array.isArray(window.delitosElegidos)) {
      if (delitosElegidos.length === 1) delitoTexto = delitosElegidos[0];
      else if (delitosElegidos.length === 2) delitoTexto = delitosElegidos[0]+" y "+delitosElegidos[1];
      else if (delitosElegidos.length > 2) delitoTexto = delitosElegidos.slice(0,-1).join(", ")+" y "+delitosElegidos.slice(-1);
    }
    data["DELITO"] = delitoTexto;

    const nomDisplay = (data["NOMBRE_PADRES_OPCION"]==="OTRO")?(data["NOMBRE_PADRES"]||""):(data["NOMBRE_PADRES_OPCION"]||"");
    const telDisplay = (data["TELÉFONO_OPCION"]==="OTRO")?(data["TELÉFONO"]||""):(data["TELÉFONO_OPCION"]||"");
    const abDisplay  = (data["ABOGADO_OPCION"]==="OTRO")?(data["ABOGADO"]||""):(data["ABOGADO_OPCION"]||"");
    data["ABOGADO"]=abDisplay; data["NOMBRE_PADRES"]=nomDisplay; data["TELÉFONO"]=telDisplay;
    data["DOMICILIO"]=(data["DOMICILIO_OPCION"]==="OTRO")?(data["DOMICILIO"]||""):(data["DOMICILIO_OPCION"]||"");
    data["MEDICO"]=(data["MEDICO"]==="SI")?"SI":"NO"; data["CONSULADO"]=(data["CONSULADO"]==="SI")?"SI":"NO";

    const intOpt = data["INTERPRETE_OPCION"] || "NO";
    let interpreteDisplay="NO";
    if (intOpt==="OTRO") interpreteDisplay=data["IDIOMA"]||"";
    else if (intOpt!=="NO") interpreteDisplay=intOpt;

    // === XLSX en memoria ===
    function U(s){return String(s??"").toUpperCase();}
    function sanitizeForFilename(s){return String(s||'').replace(/[\/\\:*?"<>|]+/g,' ').trim();}
    const filas = [
      ["Nombre",U(data["Nombre"])],
      ["Apellidos",U(data["APELLIDOS"])],
      ["Tipo de documento",U(data["TIPO DOCUMENTO"])],
      ["Nº Documento",U(data["NºDOCUMENTO"])],
      ["Sexo",U(data["SEXO"])],
      ["Nacionalidad",U(data["NACIONALIDAD"])],
      ["Nombre de los Padres",U(data["NOMBRE_PADRES"])],
      ["Fecha de nacimiento",U(data["FECHA DE NACIMIENTO"])],
      ["Lugar de nacimiento",U(data["LUGAR DE NACIMIENTO"])],
      ["Domicilio",U(data["DOMICILIO"])],
      ["Teléfono",U(data["TELÉFONO"])],
      ["Delito",U(data["DELITO"])],
      ["C.P. Agentes",U(data["C.P. AGENTES"])],
      ["Diligencias",U(data["DILIGENCIAS"])],
      ["Instructor",U(data["INSTRUCTOR"])],
      ["Lugar del hecho",U(data["LUGAR DE HECHO"])],
      ["Lugar de la detención",U(data["LUGAR DE LA DETENCIÓN"])],
      ["Hora del hecho",(document.getElementById('horaHecho')?.value||"").trim()],
      ["Hora de la detención",(document.getElementById('horaDetencion')?.value||"").trim()],
      ["Breve resumen de los hechos",U(data["BREVE RESUMEN DE LOS HECHOS"])],
      ["Indicios por los que se detiene",U(data["INDICIOS POR LOS QUE SE DETIENE"])],
      ["Abogado",U(data["ABOGADO"])],
      ["Comunicarse con",U(data["COMUNICARSE CON:"])],
      ["Informar de su detención",U(data["INFORMAR DE SU DETENCION"])],
      ["Intérprete",U(interpreteDisplay)],
      ["Médico",U(data["MEDICO"])],
      ["Consulado",U(data["CONSULADO"])],
      ["Indicativo",U(data["Indicativo"])],
      ["Fecha de generación",U(data["FECHA_GENERACION"])]
    ];
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(filas);
    ws['!cols']=[{wch:40},{wch:40}];
    XLSX.utils.book_append_sheet(wb,ws,"Resumen");
    const wbout = XLSX.write(wb,{bookType:'xlsx',type:'array'});

    const nombreBase = `${sanitizeForFilename(data["Nombre"]||"")} ${sanitizeForFilename(data["APELLIDOS"]||"")}`.trim();
    const fechaISO = new Date().toISOString().slice(0,10);
    const folderName = (nombreBase?`${nombreBase} ${fechaISO}`:`Registro ${fechaISO}`).trim();
    const xlsxName = `${folderName}.xlsx`;

    const zip = new JSZip();
    const dir = zip.folder(folderName);
    dir.file(xlsxName, wbout);

    // === Selección ODTs ===
    const PL = window.PLANTILLAS||{};
    const filesToInclude=[];
    if (PL.fax) filesToInclude.push(["Plantilla_Fax.odt","fax"]);
    if (PL.derechos_espanol) filesToInclude.push(["Derechos_ES.odt","derechos_espanol"]);

    let edadNum=null;
    if (data["FECHA DE NACIMIENTO"]) {
      const partes=String(data["FECHA DE NACIMIENTO"]).split(/[\/\-]/);
      if (partes.length>=3) {
        let d,m,y;
        if (partes[0].length===4){y=+partes[0];m=+partes[1];d=+partes[2];}
        else {d=+partes[0];m=+partes[1];y=+partes[2];}
        if(y&&m&&d){const birth=new Date(y,m-1,d);const today=new Date();
          edadNum=today.getFullYear()-birth.getFullYear();
          const mmDiff=today.getMonth()-birth.getMonth();
          if(mmDiff<0||(mmDiff===0&&today.getDate()<birth.getDate())) edadNum--;
        }
      }
    }
    if (edadNum!==null) {
      if (edadNum<18 && PL.azules) filesToInclude.push(["Plantilla_Azules.odt","azules"]);
      else if (edadNum>=18 && PL.amarillas) filesToInclude.push(["Plantilla_Amarillas.odt","amarillas"]);
    }
    switch ((intOpt||"").toUpperCase()) {
      case "RUSO": if(PL.derechos_ruso) filesToInclude.push(["Derechos_RU.odt","derechos_ruso"]); break;
      case "INGLÉS": case "INGLES": if(PL.derechos_ingles) filesToInclude.push(["Derechos_EN.odt","derechos_ingles"]); break;
      case "ÁRABE": case "ARABE": if(PL.derechos_arabe) filesToInclude.push(["Derechos_AR.odt","derechos_arabe"]); break;
      case "ITALIANO": if(PL.derechos_italiano) filesToInclude.push(["Derechos_IT.odt","derechos_italiano"]); break;
    }

    // === Añadir ODTs rellenando placeholders ===
    let odtCount=0;
    const horas={hHecho:(document.getElementById('horaHecho')?.value||"").trim(),
                 hDet:(document.getElementById('horaDetencion')?.value||"").trim()};
    const mapa=construirMapaPlaceholders(data,interpreteDisplay,horas);

    for(const [fname,key] of filesToInclude){
      const b64Original=String(PL[key]||"").replace(/^data:.*?;base64,/,"");
      if(!b64Original) continue;
      try{
        const b64Relleno=await odtConDatos(b64Original,mapa);
        dir.file(fname,b64Relleno,{base64:true});
        odtCount++;
      }catch(e){
        console.warn("No se pudo rellenar",key,e);
        dir.file(fname,b64Original,{base64:true});
        odtCount++;
      }
    }

    const zipBlob=await zip.generateAsync({type:"blob"});
    await saveBlob(zipBlob,`${folderName}.zip`);
    msg.innerText=`✅ ZIP generado con ${xlsxName}${odtCount?` + ${odtCount} ODT(s)`:''}`;

  } catch(err) {
    console.error(err);
    msg.innerText="❌ Error al generar ZIP: "+(err?.message||err);
  }
}
window.generarZIP=generarZIP;
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(r=>console.log('SW registrado:',r))
      .catch(e=>console.log('SW error:',e));
  });
}
</script>

<div id="marca-registro">
  103<br>
  JBN<br>
  486<br>
</div>
</body>
</html>
