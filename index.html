<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Registro de Detenidos - Offline</title>

  <!-- Librer√≠as -->
  <script src="./jszip.min.js"></script>
  <script src="./FileSaver.min.js"></script>
  <script src="./xlsx.full.min.js"></script>

  <!-- Plantillas en Base64 (cada .js define/a√±ade window.PLANTILLAS.*) -->
  <script src="./plantilla_amarillas.js"></script>
  <script src="./plantilla_azules.js"></script>
  <script src="./plantilla_fax.js"></script>
  <script src="./plantilla_derechos_ingles.js"></script>
  <script src="./plantilla_derechos_espanol.js"></script>
  <script src="./plantilla_derechos_arabe.js"></script>
  <script src="./plantilla_derechos_italiano.js"></script>
  <script src="./plantilla_derechos_ruso.js"></script>

  <style>
    body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:#0b2545;color:#fff}
    h1{text-align:center;margin:16px 0 20px}
    form{background:rgba(0,0,0,.75);border-radius:12px;max-width:1200px;margin:0 auto 32px;padding:24px}
    .grid-rows{display:flex;flex-wrap:wrap;gap:.5rem}
    .field-card{flex:1;min-width:220px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:10px}
    label{font-size:12px;font-weight:700;text-transform:uppercase}
    input,select,textarea{width:100%;padding:6px;border-radius:8px;border:1px solid #aaa;background:#fff;color:#000}
    .actions{margin-top:18px}
    .actions button{width:100%;padding:14px;border-radius:10px;font-weight:800;border:0;margin-bottom:10px;cursor:pointer}
    #btnDescargar{background:#003366;color:#fff}
    #btnDescargarZip{background:#66cdaa;color:#000}
    #btnCargar{background:#006400;color:#fff}
    #btnRefrescar{background:#1E90FF;color:#fff}
    #message{text-align:center;margin-top:10px;font-weight:bold}
  </style>
</head>
<body>
  <h1>Registro de Detenidos</h1>

  <form id="registroForm" autocomplete="off">
    <h2>Datos de Filiaci√≥n</h2>
    <div class="grid-rows">
      <div class="field-card">
        <label>Tipo Documento</label>
        <select name="TIPO DOCUMENTO_OPCION" id="tipoDocumento">
          <option value="INDOCUMENTADO/A" selected>INDOCUMENTADO/A</option>
          <option value="DNI">DNI</option>
          <option value="NIE">NIE</option>
          <option value="PASAPORTE">PASAPORTE</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="TIPO DOCUMENTO" id="tipoDocumentoOtro" placeholder="Especificar otro" style="display:none;">
      </div>
      <div class="field-card">
        <label>N¬∫ Documento</label>
        <input type="text" name="N¬∫DOCUMENTO" id="numeroDocumento">
      </div>
      <div class="field-card">
        <label>Sexo</label>
        <select name="SEXO_OPCION" id="sexoOpcion">
          <option value="MASCULINO" selected>MASCULINO</option>
          <option value="FEMENINO">FEMENINO</option>
        </select>
      </div>
      <div class="field-card"><label>Nacionalidad</label><input type="text" name="NACIONALIDAD"></div>
      <div class="field-card"><label>Nombre</label><input type="text" name="Nombre" id="Nombre"></div>
      <div class="field-card"><label>Apellidos</label><input type="text" name="APELLIDOS" id="APELLIDOS"></div>
      <div class="field-card">
        <label>Nombre de los Padres</label>
        <select name="NOMBRE_PADRES_OPCION" id="nombrePadresOpcion">
          <option value="NO APORTA" selected>NO APORTA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="NOMBRE_PADRES" id="nombrePadresTexto" placeholder="Especificar" style="display:none;">
      </div>
      <div class="field-card"><label>Fecha de nacimiento</label><input type="text" name="FECHA DE NACIMIENTO" placeholder="DD/MM/AAAA"></div>
      <div class="field-card"><label>Lugar de nacimiento</label><input type="text" name="LUGAR DE NACIMIENTO"></div>
      <div class="field-card">
        <label>Domicilio</label>
        <select name="DOMICILIO_OPCION" id="domicilioOpcion">
          <option value="NO APORTA" selected>NO APORTA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="DOMICILIO" id="domicilioTexto" placeholder="Especificar" style="display:none;">
      </div>
      <div class="field-card">
        <label>Tel√©fono</label>
        <select name="TEL√âFONO_OPCION" id="telefonoOpcion">
          <option value="NO APORTA" selected>NO APORTA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="TEL√âFONO" id="telefonoTexto" placeholder="Especificar" style="display:none;">
      </div>
      <div class="field-card"><label>Fecha actual por defecto</label><input type="text" name="FECHA_GENERACION" id="fechaGeneracion"></div>
    </div>

    <h2>Hechos</h2>
    <div class="grid-rows">
      <div class="field-card">
        <label>Delito(s)</label>
        <select id="delitoSelect">
          <option value="">-- Seleccionar --</option>
          <option value="HURTO">HURTO</option>
          <option value="DA√ëOS">DA√ëOS</option>
          <option value="ESTAFA">ESTAFA</option>
          <option value="ROBO CON FUERZA">ROBO CON FUERZA</option>
          <option value="ROBO USO DE VEHICULO">ROBO USO DE VEH√çCULO</option>
          <option value="HURTO USO DE VEHICULO">HURTO USO DE VEH√çCULO</option>
          <option value="ROBO CON VIOLENCIA">ROBO CON VIOLENCIA</option>
          <option value="LESIONES">LESIONES</option>
          <option value="AMENAZAS GRAVES">AMENAZAS GRAVES</option>
          <option value="MALOS TRATOS EN EL √ÅMBITO FAMILIAR">MALOS TRATOS EN EL √ÅMBITO FAMILIAR</option>
          <option value="ABUSO SEXUAL">ABUSO SEXUAL</option>
          <option value="ATENTADO AGENTE AUTORIDAD">ATENTADO AGENTE AUTORIDAD</option>
          <option value="DESOBEDIENCIA">DESOBEDIENCIA</option>
          <option value="CONTRA LA SEGURIDAD VIAL">CONTRA LA SEGURIDAD VIAL</option>
          <option value="CONTRA LA SALUD P√öBLICA">CONTRA LA SALUD P√öBLICA</option>
          <option value="TR√ÅFICO DE DROGAS">TR√ÅFICO DE DROGAS</option>
          <option value="FALSEDAD DOCUMENTAL">FALSEDAD DOCUMENTAL</option>
          <option value="RECLAMACI√ìN JUDICIAL">RECLAMACI√ìN JUDICIAL</option>
          <option value="QUEBRANTAMIENTO DE CONDENA">QUEBRANTAMIENTO DE CONDENA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" id="delitoOtroTexto" placeholder="Especificar y pulsar Enter" style="display:none;">
        <div id="delitosSeleccionados" style="margin-top:8px; padding:5px; border:1px solid #ccc; min-height:30px; background:#fff;color:#000;">
          <em>Ning√∫n delito seleccionado</em>
        </div>
      </div>
      <div class="field-card"><label>Indicativo</label><input type="text" name="Indicativo" placeholder="A-000"></div>
      <div class="field-card"><label>C.P. Agentes</label><input type="text" name="C.P. AGENTES"></div>
      <div class="field-card"><label>Diligencias</label><input type="text" name="DILIGENCIAS" placeholder="Pedir a GTD/ODAC ‚òè"></div>
      <div class="field-card"><label>Instructor</label><input type="number" name="INSTRUCTOR" placeholder="Pedir a GTD/ODAC ‚òè"></div>
      <div class="field-card"><label>Lugar del hecho</label><input type="text" name="LUGAR DEL HECHO"></div>
      <div class="field-card"><label>Lugar de la detenci√≥n</label><input type="text" name="LUGAR DE LA DETENCI√ìN"></div>
      <div class="field-card"><label>Hora del hecho</label><input type="time" name="HORA DEL HECHO" id="horaHecho"></div>
      <div class="field-card"><label>Hora de la detenci√≥n</label><input type="time" name="HORA DE LA DETENCI√ìN" id="horaDetencion"></div>
      <div class="field-card" style="flex-basis:100%"><label>Breve resumen de los hechos</label><textarea name="BREVE RESUMEN DE LOS HECHOS"></textarea></div>
      <div class="field-card" style="flex-basis:100%"><label>Indicios por los que se detiene</label><textarea name="INDICIOS POR LOS QUE SE DETIENE"></textarea></div>
    </div>

    <h2>Derechos</h2>
    <div class="grid-rows">
      <div class="field-card">
        <label>Abogado</label>
        <select name="ABOGADO_OPCION" id="abogadoOpcion">
          <option value="DE OFICIO" selected>DE OFICIO</option>
          <option value="OTRO">PARTICULAR</option>
        </select>
        <input type="text" name="ABOGADO" id="abogadoTexto" placeholder="Nombre y tel√©fono" style="display:none;">
      </div>
      <div class="field-card">
        <label>Comunicarse con</label>
        <select name="COMUNICARSE CON_OPCION" id="comunicarseOpcion">
          <option value="NADIE" selected>NADIE</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="COMUNICARSE CON:" id="comunicarseTexto" placeholder="Nombre y tel√©fono" style="display:none;">
      </div>
      <div class="field-card">
        <label>Informar de su detenci√≥n a:</label>
        <select name="INFORMAR DE SU DETENCION_OPCION" id="informardeOpcion">
          <option value="NADIE" selected>NADIE</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="INFORMAR DE SU DETENCION:" id="informardeTexto" placeholder="Nombre y tel√©fono" style="display:none;">
      </div>
      <div class="field-card">
        <label>Int√©rprete</label>
        <select name="INTERPRETE_OPCION" id="interpreteOpcion">
          <option value="NO" selected>NO</option>
          <option value="INGL√âS">INGL√âS</option>
          <option value="√ÅRABE">√ÅRABE</option>
          <option value="ITALIANO">ITALIANO</option>
          <option value="RUSO">RUSO</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="IDIOMA" id="idioma" placeholder="Especificar idioma/contexto" style="display:none;">
      </div>
      <div class="field-card">
        <label>M√©dico</label>
        <select name="MEDICO" id="medico"><option>NO</option><option>SI</option></select>
      </div>
      <div class="field-card">
        <label>Consulado</label>
        <select name="CONSULADO" id="consulado"><option>NO</option><option>SI</option></select>
      </div>
    </div>

    <div class="actions">
      <input type="file" id="fileInputXLSX" accept=".xlsx" style="display:none">
      <button type="button" id="btnDescargar">üíæ Descarga</button>
      <button type="button" id="btnDescargarZip">üì¶ ZIP (Excel y Formularios)</button>
      <button type="button" id="btnCargar">üóÇÔ∏è Carga</button>
      <button type="button" id="btnRefrescar">üîÑ Refrescar</button>
    </div>
    <div id="message"></div>
  </form>

  <!-- APP: un solo script con todo -->
  <script>
  // --- Estado global seguro ---
  window.PLANTILLAS = window.PLANTILLAS || {};
  window.delitosElegidos = [];

  // --- Helpers ---
  const U = s => String(s ?? '').toUpperCase();
  const sanitizeForFilename = s => String(s||'').replace(/[\/\\:*?"<>|]+/g,' ').trim();
  const escapeRegExp = s => s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
  function buildFlexibleRegex(key){
    const chars = key.split("").map(c=>escapeRegExp(c));
    const flexible = chars.join("(?:\\s|<[^>]+>|&nbsp;)*");
    return new RegExp("\\{\\{(?:\\s|<[^>]+>|&nbsp;)*"+flexible+"(?:\\s|<[^>]+>|&nbsp;)*\\}\\}","gi");
  }
  const xmlEscape = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  // Mostrar campos OTRO + bloquear N¬∫DOC si indocumentado + idioma si int√©rprete OTRO
  document.addEventListener('change',e=>{
    if(e.target.id==="tipoDocumento"){
      const val=e.target.value;
      document.getElementById('tipoDocumentoOtro').style.display=(val==="OTRO")?"block":"none";
      const num=document.getElementById("numeroDocumento");
      if(val==="INDOCUMENTADO/A"){ num.value=""; num.disabled=true; } else { num.disabled=false; }
    }
    if(e.target.id==="interpreteOpcion"){
      document.getElementById('idioma').style.display=(e.target.value==="OTRO")?"block":"none";
    }
    if(e.target.tagName==="SELECT" && e.target.closest('.field-card')){
      const input=e.target.closest('.field-card').querySelector('input[type="text"], textarea');
      if(input && !["tipoDocumento","interpreteOpcion"].includes(e.target.id)){
        input.style.display=(e.target.value==="OTRO")?"block":"none";
      }
    }
  });

  // Delitos multi-selecci√≥n
  (function initDelitos(){
    const selectDelito = document.getElementById("delitoSelect");
    const lista = document.getElementById("delitosSeleccionados");
    const inputOtro = document.getElementById("delitoOtroTexto");
    selectDelito.addEventListener("change", ()=>{
      const val = selectDelito.value;
      if (val === "OTRO") {
        inputOtro.style.display = "inline-block"; inputOtro.focus(); return;
      }
      if (val && !window.delitosElegidos.includes(val)) {
        window.delitosElegidos.push(val); renderDelitos();
      }
      selectDelito.value = "";
    });
    inputOtro.addEventListener("keydown", e=>{
      if(e.key==="Enter"){
        e.preventDefault();
        const val = inputOtro.value.trim();
        if(val && !window.delitosElegidos.includes(val)){
          window.delitosElegidos.push(val); renderDelitos();
        }
        inputOtro.value=""; inputOtro.style.display="none"; selectDelito.value="";
      }
    });
    function renderDelitos() {
      lista.innerHTML="";
      if(window.delitosElegidos.length===0){
        lista.innerHTML="<em>Ning√∫n delito seleccionado</em>";
        return;
      }
      window.delitosElegidos.forEach((d,i)=>{
        const span=document.createElement("span");
        span.textContent=d;
        span.style.cssText="padding:3px 6px; margin:2px; background:#eef; border:1px solid #99c; border-radius:4px; display:inline-block; cursor:pointer; color:#000";
        span.title="Click para eliminar";
        span.addEventListener("click", ()=>{ window.delitosElegidos.splice(i,1); renderDelitos(); });
        lista.appendChild(span);
      });
    }
  })();

  // Fecha por defecto
  document.addEventListener("DOMContentLoaded", function () {
    const hoy = new Date();
    const fecha = String(hoy.getDate()).padStart(2,'0') + '/' + String(hoy.getMonth()+1).padStart(2,'0') + '/' + hoy.getFullYear();
    const inputFecha = document.getElementById("fechaGeneracion");
    if (inputFecha && !inputFecha.value) inputFecha.value = fecha;
  });

  // XLSX
  function generarXLSX() {
    const msg = document.getElementById("message");
    msg.innerText = "Generando XLSX...";
    try{
      const form = document.getElementById("registroForm");
      const fd = new FormData(form);
      const data = {}; fd.forEach((v,k)=>data[k]=v);

      const optTD = data["TIPO DOCUMENTO_OPCION"];
      data["TIPO DOCUMENTO"] = (optTD === "OTRO") ? (data["TIPO DOCUMENTO"] || "") : optTD;
      if(optTD === "INDOCUMENTADO/A"){ data["N¬∫DOCUMENTO"] = ""; }
      data["SEXO"] = data["SEXO_OPCION"] || "";
      data["FECHA_GENERACION"] = document.getElementById('fechaGeneracion')?.value || '';

      let delitoTexto = "";
      if (window.delitosElegidos.length === 1) delitoTexto = window.delitosElegidos[0];
      else if (window.delitosElegidos.length === 2) delitoTexto = window.delitosElegidos[0] + " y " + window.delitosElegidos[1];
      else if (window.delitosElegidos.length > 2) delitoTexto = window.delitosElegidos.slice(0,-1).join(", ") + " y " + window.delitosElegidos.at(-1);
      data["DELITO"] = delitoTexto;

      const filas = [
        ["Nombre", U(data["Nombre"])],
        ["Apellidos", U(data["APELLIDOS"])],
        ["Tipo de documento", U(data["TIPO DOCUMENTO"])],
        ["N¬∫ Documento", U(data["N¬∫DOCUMENTO"])],
        ["Sexo", U(data["SEXO"])],
        ["Nacionalidad", U(data["NACIONALIDAD"])],
        ["Nombre de los Padres", U((data["NOMBRE_PADRES_OPCION"]==="OTRO"?data["NOMBRE_PADRES"]:data["NOMBRE_PADRES_OPCION"])||"")],
        ["Fecha de nacimiento", U(data["FECHA DE NACIMIENTO"])],
        ["Lugar de nacimiento", U(data["LUGAR DE NACIMIENTO"])],
        ["Domicilio", U((data["DOMICILIO_OPCION"]==="OTRO"?data["DOMICILIO"]:data["DOMICILIO_OPCION"])||"")],
        ["Tel√©fono", U((data["TEL√âFONO_OPCION"]==="OTRO"?data["TEL√âFONO"]:data["TEL√âFONO_OPCION"])||"")],
        ["Delito", U(data["DELITO"])],
        ["C.P. Agentes", U(data["C.P. AGENTES"])],
        ["Diligencias", U(data["DILIGENCIAS"])],
        ["Instructor", U(data["INSTRUCTOR"])],
        ["Lugar del hecho", U(data["LUGAR DEL HECHO"])],
        ["Lugar de la detenci√≥n", U(data["LUGAR DE LA DETENCI√ìN"])],
        ["Hora del hecho", (document.getElementById('horaHecho')?.value || "").trim()],
        ["Hora de la detenci√≥n", (document.getElementById('horaDetencion')?.value || "").trim()],
        ["Breve resumen de los hechos", U(data["BREVE RESUMEN DE LOS HECHOS"])],
        ["Indicios por los que se detiene", U(data["INDICIOS POR LOS QUE SE DETIENE"])],
        ["Abogado", U((data["ABOGADO_OPCION"]==="OTRO"?data["ABOGADO"]:data["ABOGADO_OPCION"])||"")],
        ["Comunicarse con", U((data["COMUNICARSE CON_OPCION"]==="OTRO"?data["COMUNICARSE CON:"]:data["COMUNICARSE CON_OPCION"])||"")],
        ["Informar de su detenci√≥n", U((data["INFORMAR DE SU DETENCION_OPCION"]==="OTRO"?data["INFORMAR DE SU DETENCION:"]:data["INFORMAR DE SU DETENCION_OPCION"])||"")],
        ["Int√©rprete", U((data["INTERPRETE_OPCION"]==="OTRO"?data["IDIOMA"]:data["INTERPRETE_OPCION"])||"NO")],
        ["M√©dico", U(data["MEDICO"])],
        ["Consulado", U(data["CONSULADO"])],
        ["Indicativo", U(data["Indicativo"])],
        ["Fecha de generaci√≥n", U(data["FECHA_GENERACION"])]
      ];

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(filas);
      ws['!cols'] = [{wch:40},{wch:40}];
      XLSX.utils.book_append_sheet(wb, ws, "Resumen");
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});

      const blob = new Blob([wbout], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
      const nombreArchivo = `${sanitizeForFilename(data["Nombre"]||"")} ${sanitizeForFilename(data["APELLIDOS"]||"")} ${new Date().toISOString().slice(0,10)}.xlsx`.trim();
      saveBlob(blob, nombreArchivo);
      msg.innerText = "‚úÖ XLSX generado y descargado";
    }catch(err){
      console.error(err);
      msg.innerText = "‚ùå Error al generar XLSX: " + (err?.message || err);
    }
  }

  async function saveBlob(blob, filename){
    if(window.showSaveFilePicker){
      try{
        const handle=await window.showSaveFilePicker({ suggestedName:filename, types:[{description:'Archivo',accept:{'*/*':['.*']}}]});
        const writable=await handle.createWritable(); await writable.write(blob); await writable.close(); return;
      }catch(e){ /* fallback */ }
    }
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a);
    a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 1500);
  }

  // --- ODT relleno ---
  async function odtConDatos(odtBase64, map) {
    if (!odtBase64) return odtBase64;
    const zipIn = await JSZip.loadAsync(String(odtBase64).replace(/^data:.*?;base64,/, ""), { base64: true });
    const contentFile = zipIn.file("content.xml");
    if (!contentFile) return odtBase64;
    let xml = await contentFile.async("string");
    for (const [key, val] of Object.entries(map)) {
      const re = buildFlexibleRegex(key);
      xml = xml.replace(re, xmlEscape(val ?? ""));
    }
    zipIn.file("content.xml", xml);
    return await zipIn.generateAsync({ type: "base64" });
  }

  function construirMapaPlaceholders(data, interpreteDisplay, horas) {
    return {
      "Nombre": data["Nombre"] || "",
      "Apellidos": data["APELLIDOS"] || "",
      "Tipo de documento": data["TIPO DOCUMENTO"] || "",
      "N¬∫ Documento": data["N¬∫DOCUMENTO"] || "",
      "N¬∫DOCUMENTO": data["N¬∫DOCUMENTO"] || "",
      "Sexo": data["SEXO"] || "",
      "Nacionalidad": data["NACIONALIDAD"] || "",
      "Nombre de los Padres": (data["NOMBRE_PADRES_OPCION"]==="OTRO"?data["NOMBRE_PADRES"]:data["NOMBRE_PADRES_OPCION"]) || "",
      "Fecha de nacimiento": data["FECHA DE NACIMIENTO"] || "",
      "Lugar de nacimiento": data["LUGAR DE NACIMIENTO"] || "",
      "Domicilio": (data["DOMICILIO_OPCION"]==="OTRO"?data["DOMICILIO"]:data["DOMICILIO_OPCION"]) || "",
      "Tel√©fono": (data["TEL√âFONO_OPCION"]==="OTRO"?data["TEL√âFONO"]:data["TEL√âFONO_OPCION"]) || "",
      "Delito": data["DELITO"] || "",
      "C.P. Agentes": data["C.P. AGENTES"] || "",
      "Diligencias": data["DILIGENCIAS"] || "",
      "Instructor": data["INSTRUCTOR"] || "",
      "Lugar del hecho": data["LUGAR DEL HECHO"] || "",
      "Lugar de la detenci√≥n": data["LUGAR DE LA DETENCI√ìN"] || "",
      "Hora del hecho": horas.hHecho || "",
      "Hora de la detenci√≥n": horas.hDet || "",
      "Breve resumen de los hechos": data["BREVE RESUMEN DE LOS HECHOS"] || "",
      "Indicios por los que se detiene": data["INDICIOS POR LOS QUE SE DETIENE"] || "",
      "Abogado": (data["ABOGADO_OPCION"]==="OTRO"?data["ABOGADO"]:data["ABOGADO_OPCION"]) || "",
      "Comunicarse con": (data["COMUNICARSE CON_OPCION"]==="OTRO"?data["COMUNICARSE CON:"]:data["COMUNICARSE CON_OPCION"]) || "",
      "Informar de su detenci√≥n": (data["INFORMAR DE SU DETENCION_OPCION"]==="OTRO"?data["INFORMAR DE SU DETENCION:"]:data["INFORMAR DE SU DETENCION_OPCION"]) || "",
      "Int√©rprete": interpreteDisplay || "",
      "M√©dico": data["MEDICO"] || "",
      "Consulado": data["CONSULADO"] || "",
      "Indicativo": data["Indicativo"] || "",
      "Fecha de generaci√≥n": data["FECHA_GENERACION"] || ""
    };
  }

  // --- Generar ZIP con XLSX + ODTs (rellenos) ---
  async function generarZIP() {
    const msg = document.getElementById("message");
    msg.innerText = "Generando ZIP...";
    try{
      const form = document.getElementById("registroForm");
      const fd = new FormData(form);
      const data = {}; fd.forEach((v,k)=>data[k]=v);

      // Normalizaciones
      const optTD = data["TIPO DOCUMENTO_OPCION"];
      data["TIPO DOCUMENTO"] = (optTD === "OTRO") ? (data["TIPO DOCUMENTO"] || "") : optTD;
      if (optTD === "INDOCUMENTADO/A") data["N¬∫DOCUMENTO"] = "";
      data["SEXO"] = data["SEXO_OPCION"] || "";
      data["FECHA_GENERACION"] = document.getElementById('fechaGeneracion')?.value || "";

      // Delitos ‚Üí string
      let delitoTexto = "";
      if (window.delitosElegidos.length === 1) delitoTexto = window.delitosElegidos[0];
      else if (window.delitosElegidos.length === 2) delitoTexto = `${window.delitosElegidos[0]} y ${window.delitosElegidos[1]}`;
      else if (window.delitosElegidos.length > 2) delitoTexto = window.delitosElegidos.slice(0,-1).join(", ") + " y " + window.delitosElegidos.at(-1);
      data["DELITO"] = delitoTexto;

      // Int√©rprete display
      const intOpt = data["INTERPRETE_OPCION"] || "NO";
      let interpreteDisplay = "NO";
      if (intOpt === "OTRO") interpreteDisplay = data["IDIOMA"] || "";
      else if (intOpt !== "NO") interpreteDisplay = intOpt;

      // XLSX en memoria
      const filas = [
        ["Nombre", U(data["Nombre"])],
        ["Apellidos", U(data["APELLIDOS"])],
        ["Tipo de documento", U(data["TIPO DOCUMENTO"])],
        ["N¬∫ Documento", U(data["N¬∫DOCUMENTO"])],
        ["Sexo", U(data["SEXO"])],
        ["Nacionalidad", U(data["NACIONALIDAD"])],
        ["Nombre de los Padres", U((data["NOMBRE_PADRES_OPCION"]==="OTRO"?data["NOMBRE_PADRES"]:data["NOMBRE_PADRES_OPCION"])||"")],
        ["Fecha de nacimiento", U(data["FECHA DE NACIMIENTO"])],
        ["Lugar de nacimiento", U(data["LUGAR DE NACIMIENTO"])],
        ["Domicilio", U((data["DOMICILIO_OPCION"]==="OTRO"?data["DOMICILIO"]:data["DOMICILIO_OPCION"])||"")],
        ["Tel√©fono", U((data["TEL√âFONO_OPCION"]==="OTRO"?data["TEL√âFONO"]:data["TEL√âFONO_OPCION"])||"")],
        ["Delito", U(data["DELITO"])],
        ["C.P. Agentes", U(data["C.P. AGENTES"])],
        ["Diligencias", U(data["DILIGENCIAS"])],
        ["Instructor", U(data["INSTRUCTOR"])],
        ["Lugar del hecho", U(data["LUGAR DEL HECHO"])],
        ["Lugar de la detenci√≥n", U(data["LUGAR DE LA DETENCI√ìN"])],
        ["Hora del hecho", (document.getElementById('horaHecho')?.value || "").trim()],
        ["Hora de la detenci√≥n", (document.getElementById('horaDetencion')?.value || "").trim()],
        ["Breve resumen de los hechos", U(data["BREVE RESUMEN DE LOS HECHOS"])],
        ["Indicios por los que se detiene", U(data["INDICIOS POR LOS QUE SE DETIENE"])],
        ["Abogado", U((data["ABOGADO_OPCION"]==="OTRO"?data["ABOGADO"]:data["ABOGADO_OPCION"])||"")],
        ["Comunicarse con", U((data["COMUNICARSE CON_OPCION"]==="OTRO"?data["COMUNICARSE CON:"]:data["COMUNICARSE CON_OPCION"])||"")],
        ["Informar de su detenci√≥n", U((data["INFORMAR DE SU DETENCION_OPCION"]==="OTRO"?data["INFORMAR DE SU DETENCION:"]:data["INFORMAR DE SU DETENCION_OPCION"])||"")],
        ["Int√©rprete", U(interpreteDisplay)],
        ["M√©dico", U(data["MEDICO"])],
        ["Consulado", U(data["CONSULADO"])],
        ["Indicativo", U(data["Indicativo"])],
        ["Fecha de generaci√≥n", U(data["FECHA_GENERACION"])]
      ];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(filas);
      ws['!cols'] = [{wch:40},{wch:40}];
      XLSX.utils.book_append_sheet(wb, ws, "Resumen");
      const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });

      // Carpeta y nombre
      const nombreBase = `${sanitizeForFilename(data["Nombre"]||"")} ${sanitizeForFilename(data["APELLIDOS"]||"")}`.trim();
      const fechaISO = new Date().toISOString().slice(0,10);
      const folderName = (nombreBase ? `${nombreBase} ${fechaISO}` : `Registro ${fechaISO}`).trim();
      const xlsxName = `${folderName}.xlsx`;

      const zip = new JSZip();
      const dir = zip.folder(folderName);
      dir.file(xlsxName, wbout);

      // Selecci√≥n ODTs
      const PL = window.PLANTILLAS || {};
      const filesToInclude = [];
      if (PL.fax) filesToInclude.push(["Plantilla_Fax.odt", "fax"]);
      if (PL.derechos_espanol) filesToInclude.push(["Derechos_ES.odt", "derechos_espanol"]);

      // Edad para azules/amarillas
      let edadNum = null;
      if (data["FECHA DE NACIMIENTO"]) {
        const p = String(data["FECHA DE NACIMIENTO"]).split(/[\/\-]/);
        if (p.length >= 3) {
          let d,m,y; if (p[0].length===4){ y=+p[0]; m=+p[1]; d=+p[2]; } else { d=+p[0]; m=+p[1]; y=+p[2]; }
          if (y&&m&&d){
            const birth=new Date(y,m-1,d), today=new Date();
            edadNum=today.getFullYear()-birth.getFullYear();
            const mm=today.getMonth()-birth.getMonth();
            if (mm<0 || (mm===0 && today.getDate()<birth.getDate())) edadNum--;
          }
        }
      }
      if (edadNum!==null) {
        if (edadNum < 18 && PL.azules) filesToInclude.push(["Plantilla_Azules.odt", "azules"]);
        else if (edadNum >= 18 && PL.amarillas) filesToInclude.push(["Plantilla_Amarillas.odt", "amarillas"]);
      }

      // Int√©rprete -> derechos idioma
      const lang = (data["INTERPRETE_OPCION"]||"").toUpperCase();
      if ((lang==="INGL√âS"||lang==="INGLES") && PL.derechos_ingles)   filesToInclude.push(["Derechos_EN.odt","derechos_ingles"]);
      if ((lang==="√ÅRABE"||lang==="ARABE")   && PL.derechos_arabe)    filesToInclude.push(["Derechos_AR.odt","derechos_arabe"]);
      if (lang==="ITALIANO"                  && PL.derechos_italiano) filesToInclude.push(["Derechos_IT.odt","derechos_italiano"]);
      if (lang==="RUSO"                      && PL.derechos_ruso)     filesToInclude.push(["Derechos_RU.odt","derechos_ruso"]);

      // Rellenar placeholders y a√±adir
      const horas = {
        hHecho: (document.getElementById('horaHecho')?.value || "").trim(),
        hDet:   (document.getElementById('horaDetencion')?.value || "").trim()
      };
      const mapa = construirMapaPlaceholders(data, interpreteDisplay, horas);

      let odtCount = 0;
      for (const [fname, key] of filesToInclude) {
        const b64Original = String(PL[key] || "").replace(/^data:.*?;base64,/, "");
        if (!b64Original) continue;
        try {
          const b64Relleno = await odtConDatos(b64Original, mapa);
          dir.file(fname, b64Relleno, { base64:true });
          odtCount++;
        } catch (e) {
          console.warn("No se pudo rellenar la plantilla", key, e);
          dir.file(fname, b64Original, { base64:true });
          odtCount++;
        }
      }

      // Generar ZIP
      const zipBlob = await zip.generateAsync({ type:"blob" });
      await saveBlob(zipBlob, `${folderName}.zip`);
      msg.innerText = `‚úÖ ZIP generado con ${xlsxName}${odtCount ? ` + ${odtCount} ODT(s)` : ""}`;
    }catch(err){
      console.error(err);
      msg.innerText = "‚ùå Error al generar ZIP: " + (err?.message || err);
    }
  }

  // === Botones (sin inline onclick) ===
  document.getElementById('btnDescargar').addEventListener('click', generarXLSX);
  document.getElementById('btnDescargarZip').addEventListener('click', generarZIP);
  document.getElementById('btnCargar').addEventListener('click', ()=> {
    const input = document.getElementById("fileInputXLSX");
    input.value = null; input.click();
    input.onchange = async (e) => {
      const file = e.target.files[0]; if (!file) return;
      try {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type:"array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        rows.forEach(([pregunta, respuesta])=>{
          if (!pregunta) return;
          const r = (respuesta || "").toString().trim();
          const allInputs = document.querySelectorAll("[name]");
          for (const el of allInputs) {
            if (String(el.name).trim().toUpperCase() === String(pregunta).trim().toUpperCase()){
              if (el.tagName==="SELECT"){ el.value=r; el.dispatchEvent(new Event("change")); }
              else if (el.type==="time"){ el.value=/^\d{1,2}:\d{2}$/.test(r)?(r.length===4?"0"+r:r):""; }
              else { el.value=r; }
              break;
            }
          }
        });
        document.getElementById("message").innerText = "‚úÖ XLSX cargado y formulario rellenado";
      }catch(err){
        console.error(err);
        document.getElementById("message").innerText = "‚ùå Error al cargar XLSX: " + (err?.message || err);
      }
    };
  });

  // Exponer por si quieres seguir usando onclick en tu HTML antiguo
  window.generarXLSX = generarXLSX;
  window.generarZIP  = generarZIP;

  // SW opcional
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
    });
  }
  </script>
</body>
</html>
