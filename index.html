<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de Detenidos - Formato Completo Offline</title>

  <!-- Librer√≠as necesarias -->
  <script src="./jszip.min.js"></script>
  <script src="./FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Plantillas Base64: deben definir window.PLANTILLAS con claves:
       { amarillas, azules, fax, derechos_ingles, derechos_espanol } -->
  <script src="./plantilla_amarillas.js"></script>
  <script src="./plantilla_azules.js"></script>
  <script src="./plantilla_fax.js"></script>
  <script src="./plantilla_derechos_ingles.js"></script>
  <script src="./plantilla_derechos_espanol.js"></script>
  <script src="./plantilla_derechos_arabe.js"></script>
  <script src="./plantilla_derechos_italiano.js"></script>
  <script src="./plantilla_derechos_ruso.js"></script>
  <style>
    :root { --primary:#3498db; --hover:#2980b9; --panel:rgba(0,0,0,0.75); --text:#fff; --field-bg:rgba(255,255,255,0.9); --border:#aaa; --radius:12px; --space:16px; --card-pad:14px; }
    *{box-sizing:border-box}
    body{margin:0;padding:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:url('fondo.jpg') no-repeat center center fixed;background-size:cover;min-height:100vh;display:flex;flex-direction:column;justify-content:center;}
    h1{text-align:center;margin:16px 0 20px;font-size:32px;font-weight:800;color:#fff;text-transform:uppercase;text-shadow:2px 2px 8px rgba(0,0,0,.7);}
    form{background:var(--panel);color:var(--text);border-radius:var(--radius);max-width:1400px;margin:0 auto 32px;padding:28px 32px;box-shadow:0 10px 28px rgba(0,0,0,.6);}
    h2{font-size:20px;text-transform:uppercase;margin-top:28px;margin-bottom:12px;border-bottom:2px solid var(--primary);padding-bottom:6px;letter-spacing:.5px;}
    .grid-rows{display:grid;grid-gap:var(--space);grid-template-columns: repeat(3, minmax(280px,1fr));}
    @media(max-width:1200px){.grid-rows{grid-template-columns:repeat(2,minmax(280px,1fr));}}
    @media(max-width:700px){.grid-rows{grid-template-columns:1fr;}}
    .field-card{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.18);border-radius:10px;padding:var(--card-pad);display:flex;flex-direction:column;gap:8px;min-height:94px;}
    label{font-weight:700;font-size:12px;margin-bottom:2px;text-transform:uppercase;letter-spacing:.6px;}
    input,select,textarea{width:100%;padding:5px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--field-bg);color:#000;}
    textarea{resize:vertical;min-height:56px;}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(52,152,219,.25);}
    .actions{text-align:center;margin-top:26px;}
    button{background:var(--primary);color:#fff;padding:14px 26px;border:none;border-radius:10px;font-weight:800;font-size:15px;text-transform:uppercase;cursor:pointer;letter-spacing:.6px;}
    button:hover{background:var(--hover);}
    #message{margin-top:12px;text-align:center;font-weight:bold;color:#fff;}
.full-width {
      grid-column: span 3;
    }
/* Reduce la altura por defecto de todas las tarjetas */
.field-card {
  padding: 10px;        /* antes var(--card-pad)=14px */
  gap: 6px;             /* antes 8px */
  min-height: 64px;     /* antes 94px */
}
textarea {
  min-height: 34px;     /* altura visible del textarea */
}

.actions {
  display: flex;
  flex-direction: column;   /* por defecto en m√≥vil: en columna */
  align-items: center;
}

.actions button {
  margin-bottom: 20px;
  padding: .5rem 1rem;
  border: none;
  border-radius: 5px;
  font-size: 16px;
  cursor: pointer;
  width: 100%;  /* en m√≥vil ocupa todo el ancho */
  color: white;
}

/* Colores */
.actions .zip {
  background-color: darkblue;      /* Bot√≥n ZIP en azul oscuro */
}
.actions .xlsx-solo {
  background-color: #66cdaa;
}
	  
.actions .xlsx {
  background-color: #28a745;   /* Bot√≥n XLSX en verde */
}
.actions .refresh {
  background-color: #007bff;   /* Bot√≥n refrescar en azul */
}

/* PC/escritorio: horizontal */
@media (min-width: 768px) {
  .actions {
    flex-direction: row;       /* se alinean en fila */
    justify-content: center;
    gap: 20px;                 /* espacio horizontal */
  }
  .actions button {
    width: auto;               /* se ajustan al texto */
    margin-bottom: 0;
  }
}

  </style>

</head>
<body>
  <h1>Registro de Detenidos</h1>

  <form id="registroForm" autocomplete="off">
    <h2>Datos de Filiaci√≥n</h2>
    <div class="grid-rows">
      <div class="field-card" style="color: lightblue;">
        <label>Tipo Documento</label>
        <select name="TIPO DOCUMENTO_OPCION" id="tipoDocumento">
          <option value="INDOCUMENTADO/A" selected>INDOCUMENTADO/A</option>
          <option value="DNI">DNI</option>
          <option value="NIE">NIE</option>
          <option value="PASAPORTE">PASAPORTE</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="TIPO DOCUMENTO" id="tipoDocumentoOtro" placeholder="Especificar otro" style="display:none;">
      </div>
      <div class="field-card" style="color: lightblue;">
        <label>N¬∫ Documento</label>
        <input type="text" name="N¬∫DOCUMENTO" id="numeroDocumento">
      </div>
      <div class="field-card" style="color: lightblue;">
        <label>Sexo</label>
        <select name="SEXO_OPCION" id="sexoOpcion">
          <option value="MASCULINO" selected>MASCULINO</option>
          <option value="FEMENINO">FEMENINO</option>
        </select>
      </div>
      <div class="field-card" style="color: lightblue;"><label>Nacionalidad</label><input type="text" name="NACIONALIDAD" id="nacionalidadtexto" placeholder="Pa√≠s"></div>
      <div class="field-card" style="color: lightblue;"><label>Nombre</label><input type="text" name="Nombre" id="Nombre"></div>
      <div class="field-card" style="color: lightblue;"><label>Apellidos</label><input type="text" name="APELLIDOS" id="APELLIDOS"></div>
     <div class="field-card" style="color: lightblue;">
  <label>Nombre de los Padres</label>
  <select name="NOMBRE_PADRES_OPCION" id="nombrePadresOpcion">
    <option value="NO APORTA" selected>NO APORTA</option>
    <option value="OTRO">OTRO</option>
  </select>
  <input type="text" name="NOMBRE_PADRES" id="nombrePadresTexto" placeholder="Especificar" style="display:none;">
</div>
      <div class="field-card" style="color: lightblue;"><label>Fecha de nacimiento</label><input type="text" name="FECHA DE NACIMIENTO" placeholder="DD/MM/AAAA"></div>
      <div class="field-card" style="color: lightblue;"><label>Lugar de nacimiento</label><input type="text" name="LUGAR DE NACIMIENTO"></div>
      <div class="field-card" style="color: lightblue;">
        <label>Domicilio</label>
        <select name="DOMICILIO_OPCION" id="domicilioOpcion">
          <option value="NO APORTA" selected>NO APORTA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="DOMICILIO" id="domicilioTexto" placeholder="Especificar" style="display:none;">
      </div>
      <div class="field-card" style="color: lightblue;">
        <label>Tel√©fono</label>
        <select name="TEL√âFONO_OPCION" id="telefonoOpcion">
          <option value="NO APORTA" selected>NO APORTA</option>
          <option value="OTRO">OTRO</option>
        </select>
        <input type="text" name="TEL√âFONO" id="telefonoTexto" placeholder="Especificar" style="display:none;"></div>
      <div class="field-card" style="color: red;"><label>Fecha actual por defecto</label><input type="text" name="FECHA_GENERACION" id="fechaGeneracion"></div>
    </div>


    <h2>Hechos</h2>
    <div class="grid-rows">
      <div class="field-card" style="color: green;">
  <label>Delito(s)</label>
  <select id="delitoSelect">
    <option value="">-- Seleccionar --</option>
    <option value="HURTO">HURTO</option>
    <option value="DA√ëOS">DA√ëOS</option>
    <option value="ESTAFA">ESTAFA</option>
    <option value="ROBO CON FUERZA">ROBO CON FUERZA</option>
    <option value="ROBO USO DE VEHICULO">ROBO USO DE VEH√çCULO</option>
    <option value="HURTO USO DE VEHICULO">HURTO USO DE VEH√çCULO</option>
    <option value="ROBO CON VIOLENCIA">ROBO CON VIOLENCIA</option>
    <option value="LESIONES">LESIONES</option>
    <option value="AMENAZAS GRAVES">AMENAZAS GRAVES</option>
    <option value="MALOS TRATOS EN EL √ÅMBITO FAMILIAR">MALOS TRATOS EN EL √ÅMBITO FAMILIAR</option>
    <option value="ABUSO SEXUAL">ABUSO SEXUAL</option>
    <option value="ATENTADO AGENTE AUTORIDAD">ATENTADO AGENTE AUTORIDAD</option>
    <option value="DESOBEDIENCIA">DESOBEDIENCIA</option>
    <option value="CONTRA LA SEGURIDAD VIAL">CONTRA LA SEGURIDAD VIAL</option>
    <option value="CONTRA LA SALUD P√öBLICA">CONTRA LA SALUD P√öBLICA</option>
    <option value="TR√ÅFICO DE DROGAS">TR√ÅFICO DE DROGAS</option>
    <option value="FALSEDAD DOCUMENTAL">FALSEDAD DOCUMENTAL</option>
    <option value="RECLAMACI√ìN JUDICIAL">RECLAMACI√ìN JUDICIAL</option>
    <option value="QUEBRANTAMIENTO DE CONDENA">QUEBRANTAMIENTO DE CONDENA</option>
    <option value="OTRO">OTRO</option>
  </select>

  <!-- input para OTRO -->
  <input type="text" id="delitoOtroTexto" placeholder="Especificar" style="display:none;">

  <!-- sub-globo inferior -->
  <div id="delitosSeleccionados" style="margin-top:8px; padding:5px; border:1px solid #ccc; min-height:30px;">
    <em>Ning√∫n delito seleccionado</em>
  </div>
</div>
      <div class="field-card" style="color: lightgreen;"><label>Indicativo</label><input type="text" name="Indicativo" id="indicativotexto" placeholder="A-000"></div>
      <div class="field-card" style="color: lightgreen;"><label>C.P. Agentes</label><input type="text" name="C.P. AGENTES" id="agentestexto"></div>
      <div class="field-card" style="color: lightgreen;"><label>Diligencias</label><input type="text" name="DILIGENCIAS" id="diligenciatexto" placeholder="Pedir a GTD/ODAC ‚òè"></div>
      <div class="field-card" style="color: lightgreen;"><label>Instructor</label><input type="text" name="INSTRUCTOR" id="instructortexto" placeholder="Pedir a GTD/ODAC ‚òè"></div>
      <div class="field-card" style="color: lightgreen;"><label>Lugar del hecho</label><input type="text" name="LUGAR DEL HECHO"></div>
      <div class="field-card" style="color: lightgreen;"><label>Lugar de la detenci√≥n</label><input type="text" name="LUGAR DE LA DETENCI√ìN"></div>
      <div class="field-card" style="color: lightgreen;"><label>Hora del hecho</label><input type="time" name="HORA DEL HECHO" id="horaHecho"></div>
<div class="field-card" style="color: lightgreen;"><label>Hora de la detenci√≥n</label><input type="time" name="HORA DE LA DETENCI√ìN" id="horaDetencion"></div>
<div class="field-card full-width" style="color: lightgreen;">
  <label>Breve resumen de los hechos</label><textarea name="BREVE RESUMEN DE LOS HECHOS" id="brevetexto" placeholder="Ej: Autor de agresi√≥n con arma blanca..."></textarea>
</div>

<div class="field-card full-width" style="color: lightgreen;">
  <label>Indicios por los que se detiene</label><textarea name="INDICIOS POR LOS QUE SE DETIENE" id="indiciostexto" placeholder="Ej: Manifestaciones perjudicado, testigos..."></textarea>
</div>
</div>
<h2>Derechos</h2>
<div class="grid-rows">
  <div class="field-card" style="color: orange;">
    <label>Abogado</label>
    <select name="ABOGADO_OPCION" id="abogadoOpcion">
      <option value="DE OFICIO" selected>DE OFICIO</option>
      <option value="OTRO">PARTICULAR</option>
    </select>
    <input type="text" name="ABOGADO" id="abogadoTexto" placeholder="Nombre y tel√©fono" style="display:none;">
  </div>
  <div class="field-card" style="color: orange;">
    <label>Comunicarse con</label>
    <select name="COMUNICARSE CON_OPCION" id="comunicarseOpcion">
      <option value="NADIE" selected>NADIE</option>
      <option value="OTRO">OTRO</option>
    </select>
    <input type="text" name="COMUNICARSE CON:" id="comunicarseTexto" placeholder="Nombre y tel√©fono" style="display:none;">
  </div>
  <div class="field-card" style="color: orange;">
    <label>Informar de su detenci√≥n a:</label>
    <select name="INFORMAR DE SU DETENCI√ìN_OPCION" id="informardeOpcion">
      <option value="NADIE" selected>NADIE</option>
      <option value="OTRO">OTRO</option>
    </select>
    <input type="text" name="INFORMAR DE SU DETENCION A:" id="informardeTexto" placeholder="Nombre y tel√©fono" style="display:none;">
  </div>

  <div class="field-card" style="color: orange;">
    <label>Int√©rprete</label>
    <select name="INTERPRETE_OPCION" id="interpreteOpcion">
      <option value="NO" selected>NO</option>
      <option value="INGL√âS">INGL√âS</option>
      <option value="√ÅRABE">√ÅRABE</option>
      <option value="ITALIANO">ITALIANO</option>
      <option value="RUSO">RUSO</option>
      <option value="OTRO">OTRO</option>
    </select>
    <input type="text" name="IDIOMA" id="idioma" placeholder="Especificar idioma/contexto" style="display:none;">
  </div>
  <div class="field-card" style="color: orange;">
    <label>M√©dico</label>
    <select name="MEDICO" id="medico">
      <option value="NO" selected>NO</option>
      <option value="SI">SI</option>
    </select>
  </div>
  <div class="field-card" style="color: orange;">
    <label>Consulado</label>
    <select name="CONSULADO" id="consulado">
      <option value="NO" selected>NO</option>
      <option value="SI">SI</option>
    </select>
  </div>
</div>

<div class="actions">
  <input type="file" id="fileInputXLSX" accept=".xlsx" style="display:none">

  <!-- Descarga ZIP (darkblue con icono) -->
  <button type="button" class="zip" onclick="generarZipUnicoSeguro()">
    üíæ Descarga de ZIP
  </button>

  <!-- Nuevo bot√≥n para descargar solo XLSX -->
  <button type="button" class="xlsx-solo" onclick="descargarSoloExcel()">
    üì• Descargar Excel
  </button>

  <!-- Cargar XLSX (verde con icono) -->
  <button type="button" class="xlsx" onclick="cargarExcel()">
    üìÅ Cargar XLSX
  </button>

  <!-- Refrescar (azul con icono) -->
  <button type="button" class="refresh" onclick="location.reload();">
    üîÑ Refrescar
  </button>
</div>

<div id="message"></div>
</form>

<script>
  // Variables globales
  let delitosElegidos = [];

  // Funciones auxiliares usadas en cargarExcel
  function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }
  function buildFlexibleRegex(key) {
    const chars = key.split("").map(c => escapeRegExp(c));
    const flexible = chars.join("(?:\\s|<[^>]+>|&nbsp;)*");
    return new RegExp("\\{\\{(?:\\s|<[^>]+>|&nbsp;)*" + flexible + "(?:\\s|<[^>]+>|&nbsp;)*\\}\\}", "gi");
  }
  function normalizeKey(str) {
    return str
      ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().replace(/[^A-Z0-9]/g, "").trim()
      : "";
  }
  function U(s) { return String(s ?? '').toUpperCase(); }
  function sanitizeForFilename(s) { return String(s || '').replace(/[\/\\:*?"<>|]+/g, ' ').trim(); }

  // Mostrar inputs "OTRO" y bloquear N¬∫DOC si indocumentado, mostrar idioma si int√©rprete "OTRO"
  document.addEventListener('change', e => {
    if (e.target.id === "tipoDocumento") {
      const val = e.target.value;
      document.getElementById('tipoDocumentoOtro').style.display = (val === "OTRO") ? "block" : "none";
      const num = document.getElementById("numeroDocumento");
      if (val === "INDOCUMENTADO/A") { num.value = ""; num.disabled = true; } else { num.disabled = false; }
    }
    if (e.target.id === "interpreteOpcion") {
      document.getElementById('idioma').style.display = (e.target.value === "OTRO") ? "block" : "none";
    }
    if (e.target.tagName === "SELECT" && e.target.closest('.field-card')) {
      const input = e.target.closest('.field-card').querySelector('input[type="text"]');
      if (input && !["tipoDocumento", "interpreteOpcion"].includes(e.target.id)) {
        input.style.display = (e.target.value === "OTRO") ? "block" : "none";
      }
    }
  });

  // Funci√≥n para setear selects con input asociado (NO APORTA / OTRO)
  function setSelectWithInput(selectName, excelValue) {
    const select = document.querySelector(`[name="${selectName}"]`);
    if (!select) return;

    const card = select.closest(".field-card");
    const textInput = card ? card.querySelector("input[type=text], textarea") : null;
    const normExcel = normalizeKey(excelValue);

    let matched = false;
    for (const opt of select.options) {
      if (normalizeKey(opt.value) === normExcel) {
        select.value = opt.value;
        matched = true;
        if (textInput) {
          textInput.value = "";
          textInput.style.display = "none";
        }
        break;
      }
    }

    if (!matched) {
      if (!excelValue || ["NOAPORTA", "NO", "DEOFICIO"].includes(normExcel)) {
        const fallback = Array.from(select.options).find(opt =>
          ["NOAPORTA", "NO", "DEOFICIO"].includes(normalizeKey(opt.value))
        );
        if (fallback) select.value = fallback.value;
        if (textInput) {
          textInput.value = "";
          textInput.style.display = "none";
        }
      } else {
        const otherOpt = Array.from(select.options).find(opt => normalizeKey(opt.value) === "OTRO");
        if (otherOpt) select.value = otherOpt.value;
        if (textInput) {
          textInput.value = excelValue;
          textInput.style.display = "block";
        }
      }
    }
  }

  // Funci√≥n para cargar Excel y rellenar formulario
  async function cargarExcel() {
    const input = document.getElementById("fileInputXLSX");
    input.value = null;
    input.click();

    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        rows.forEach(([pregunta, respuesta]) => {
          if (!pregunta) return;
          const qNorm = normalizeKey(pregunta);
          const r = (respuesta || "").toString().trim();

          if (qNorm.includes("TIPO") && qNorm.includes("DOCUMENTO")) {
            setSelectWithInput("TIPO DOCUMENTO_OPCION", r);
            return;
          }
          if (qNorm === "DOMICILIO") { setSelectWithInput("DOMICILIO_OPCION", r); return; }
          if (qNorm === "TELEFONO") { setSelectWithInput("TEL√âFONO_OPCION", r); return; }
          if (qNorm === "NOMBREDELOSPADRES") { setSelectWithInput("NOMBRE_PADRES_OPCION", r); return; }
          if (qNorm === "ABOGADO") { setSelectWithInput("ABOGADO_OPCION", r); return; }
          if (qNorm === "COMUNICARSECON") { setSelectWithInput("COMUNICARSE CON_OPCION", r); return; }
          if (qNorm === "INFORMARDESUDETENCION" || qNorm === "INFORMARDESUDETENCIONA" || qNorm === "INFORMARDESUDETENCIONA:") {
            setSelectWithInput("INFORMAR DE SU DETENCION A_OPCION", r);
            return;
          }
          if (qNorm === "INTERPRETE") { setSelectWithInput("INTERPRETE_OPCION", r); return; }

          if (qNorm === "DELITO") {
            delitosElegidos = r.split(/,\s*|\s+y\s+/).map(v => v.trim()).filter(Boolean);
            renderDelitos();
            return;
          }

          const allInputs = document.querySelectorAll("[name]");
          for (const el of allInputs) {
            const elNorm = normalizeKey(el.name);
            if (elNorm === qNorm) {
              if (el.tagName === "SELECT") {
                el.value = r;
                el.dispatchEvent(new Event("change"));
              } else if (el.tagName === "INPUT" && el.type === "time") {
                if (/^\d{1,2}:\d{2}$/.test(r)) {
                  el.value = r.length === 4 ? "0" + r : r;
                } else {
                  el.value = "";
                }
              } else {
                el.value = r;
              }
              break;
            }
          }
        });

        document.getElementById("message").innerText = "‚úÖ XLSX cargado y formulario rellenado";
      } catch (err) {
        console.error(err);
        document.getElementById("message").innerText = "‚ùå Error al cargar XLSX: " + (err?.message || err);
      }
    };
  }

  // Funci√≥n com√∫n para preparar datos y filas para Excel
  function prepararDatosExcel() {
    const form = document.getElementById("registroForm");
    const fd = new FormData(form);
    const data = {};
    fd.forEach((v, k) => data[k] = v);

    const optTD = data["TIPO DOCUMENTO_OPCION"];
    data["TIPO DOCUMENTO"] = (optTD === "OTRO") ? (data["TIPO DOCUMENTO"] || "") : optTD;
    if (optTD === "INDOCUMENTADO/A") { data["N¬∫DOCUMENTO"] = ""; } else { data["N¬∫DOCUMENTO"] = data["N¬∫DOCUMENTO"] || ""; }
    data["SEXO"] = data["SEXO_OPCION"] || "";
    data["INSTRUCTOR"] = data["INSTRUCTOR"] || "";
    data["FECHA_GENERACION"] = document.getElementById('fechaGeneracion')?.value || '';

    let delitoTexto = "";
    if (delitosElegidos.length === 1) {
      delitoTexto = delitosElegidos[0];
    } else if (delitosElegidos.length === 2) {
      delitoTexto = delitosElegidos[0] + " y " + delitosElegidos[1];
    } else if (delitosElegidos.length > 2) {
      delitoTexto = delitosElegidos.slice(0, -1).join(", ") + " y " + delitosElegidos[delitosElegidos.length - 1];
    }
    data["DELITO"] = delitoTexto;

    const abOpt = data["ABOGADO_OPCION"];
    if (abOpt === "DE OFICIO") { data["ABOGADO"] = "de oficio."; }
    else if (abOpt === "OTRO") { data["ABOGADO"] = (data["ABOGADO"] || ""); }
    else { data["ABOGADO"] = data["ABOGADO"] || ""; }

    const ccOpt = data["COMUNICARSE CON_OPCION"];
    if (ccOpt === "NADIE") { data["COMUNICARSE CON:"] = "nadie."; }
    else if (ccOpt === "OTRO") { data["COMUNICARSE CON:"] = (data["COMUNICARSE CON:"] || ""); }
    else { data["COMUNICARSE CON:"] = data["COMUNICARSE CON:"] || ""; }

    const infOpt = data["INFORMAR DE SU DETENCION A_OPCION"] || data["INFORMAR DE SU DETENCION A:"] || "";
    if (infOpt === "NADIE") { data["INFORMAR DE SU DETENCION A:"] = "nadie."; }
    else if (infOpt === "OTRO") { data["INFORMAR DE SU DETENCION A:"] = (data["INFORMAR DE SU DETENCION A:"] || ""); }
    else { data["INFORMAR DE SU DETENCION A:"] = data["INFORMAR DE SU DETENCION A:"] || ""; }

    const intOpt = data["INTERPRETE_OPCION"] || "NO";
    let interpreteDisplay = "NO";

    if (intOpt === "OTRO") {
      interpreteDisplay = data["IDIOMA"] || "";
    } else if (intOpt !== "NO") {
      interpreteDisplay = intOpt;
    }
    data["IDIOMA"] = interpreteDisplay;
    data["INTERPRETE"] = interpreteDisplay;

    const nomDisplay = (data["NOMBRE_PADRES_OPCION"] === "OTRO") ? (data["NOMBRE_PADRES"] || "") : (data["NOMBRE_PADRES_OPCION"] || "");
    const domDisplay = (data["DOMICILIO_OPCION"] === "OTRO") ? (data["DOMICILIO"] || "") : (data["DOMICILIO_OPCION"] || "");
    const telDisplay = (data["TEL√âFONO_OPCION"] === "OTRO") ? (data["TEL√âFONO"] || "") : (data["TEL√âFONO_OPCION"] || "");

    data["MEDICO"] = (data["MEDICO"] === "SI") ? "SI" : "NO";
    data["CONSULADO"] = (data["CONSULADO"] === "SI") ? "SI" : "NO";

    data["NOMBRE_PADRES"] = nomDisplay;
    data["Nombre de los Padres"] = nomDisplay;
    data["DOMICILIO"] = domDisplay;
    data["TEL√âFONO"] = telDisplay;

    const hoy = new Date();
    const dd = String(hoy.getDate()).padStart(2, '0');
    const mm = String(hoy.getMonth() + 1).padStart(2, '0');
    const yyyy = String(hoy.getFullYear());
    const fechaStr = `${dd}-${mm}-${yyyy}`;
    const excelName = `${sanitizeForFilename(data["Nombre"] || "")} ${sanitizeForFilename(data["APELLIDOS"] || "")} ${fechaStr}.xlsx`.trim();

    const filas = [
      ["Nombre", (data["Nombre"] || "").toUpperCase()],
      ["Apellidos", (data["APELLIDOS"] || "").toUpperCase()],
      ["Tipo de documento", (data["TIPO DOCUMENTO"] || "").toUpperCase()],
      ["N¬∫ Documento", (data["N¬∫DOCUMENTO"] || "").toUpperCase()],
      ["Sexo", (data["SEXO"] || "").toUpperCase()],
      ["Nacionalidad", (data["NACIONALIDAD"] || "").toUpperCase()],
      ["Nombre de los Padres", (data["Nombre de los Padres"] || "").toUpperCase()],
      ["Fecha de nacimiento", (data["FECHA DE NACIMIENTO"] || "").toUpperCase()],
      ["Lugar de nacimiento", (data["LUGAR DE NACIMIENTO"] || "").toUpperCase()],
      ["Domicilio", (domDisplay || "").toUpperCase()],
      ["Tel√©fono", (telDisplay || "").toUpperCase()],
      ["Delito", (data["DELITO"] || "").toUpperCase()],
      ["C.P. Agentes", (data["C.P. AGENTES"] || "").toUpperCase()],
      ["Diligencias", (data["DILIGENCIAS"] || "").toUpperCase()],
      ["Instructor", (data["INSTRUCTOR"] || "").toUpperCase()],
      ["Lugar del hecho", (data["LUGAR DEL HECHO"] || "").toUpperCase()],
      ["Lugar de la detenci√≥n", (data["LUGAR DE LA DETENCI√ìN"] || "").toUpperCase()],
      ["Hora del hecho", (document.getElementById('horaHecho')?.value || data["HORA DEL HECHO"] || "").trim()],
      ["Hora de la detenci√≥n", (document.getElementById('horaDetencion')?.value || data["HORA DE LA DETENCI√ìN"] || "").trim()],
      ["Breve resumen de los hechos", (data["BREVE RESUMEN DE LOS HECHOS"] || "").toUpperCase()],
      ["Indicios por los que se detiene", (data["INDICIOS POR LOS QUE SE DETIENE"] || "").toUpperCase()],
      ["Abogado", (data["ABOGADO"] || "").toUpperCase()],
      ["Comunicarse con", (data["COMUNICARSE CON:"] || "").toUpperCase()],
      ["Informar de su detenci√≥n a:", (data["INFORMAR DE SU DETENCION A:"] || "").toUpperCase()],
      ["Int√©rprete", (interpreteDisplay || "").toUpperCase()],
      ["M√©dico", (data["MEDICO"] || "").toUpperCase()],
      ["Consulado", (data["CONSULADO"] || "").toUpperCase()],
      ["Indicativo", (data["Indicativo"] || "").toUpperCase()],
      ["Fecha de generaci√≥n", (data["FECHA_GENERACION"] || "").toUpperCase()]
    ];

    return { filas, excelName };
  }

  // Funci√≥n para descargar solo Excel
  async function descargarSoloExcel() {
    const msg = document.getElementById("message");
    msg.innerText = "Generando Excel...";

    try {
      const { filas, excelName } = prepararDatosExcel();

      const xlsx = await generarXLSXUint8(filas, "Resumen");

      const blob = new Blob([xlsx], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = excelName || "resumen.xlsx";
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 1500);

      msg.innerText = "‚úÖ Excel generado y descargado";
    } catch (err) {
      console.error(err);
      msg.innerText = "‚ùå Error al generar Excel: " + (err?.message || err);
    }
  }

  // Funci√≥n para generar ZIP con ODTs y Excel
  async function generarZipUnicoSeguro() {
    const msg = document.getElementById("message");
    msg.innerText = "Generando ZIP...";
    try {
      const form = document.getElementById("registroForm");
      const fd = new FormData(form);
      const data = {};
      fd.forEach((v, k) => data[k] = v);

      // Normalizaciones previas (igual que en prepararDatosExcel)
      const optTD = data["TIPO DOCUMENTO_OPCION"];
      data["TIPO DOCUMENTO"] = (optTD === "OTRO") ? (data["TIPO DOCUMENTO"] || "") : optTD;
      if (optTD === "INDOCUMENTADO/A") { data["N¬∫DOCUMENTO"] = ""; } else { data["N¬∫DOCUMENTO"] = data["N¬∫DOCUMENTO"] || ""; }
      data["SEXO"] = data["SEXO_OPCION"] || "";
      data["INSTRUCTOR"] = data["INSTRUCTOR"] || "";
      data["FECHA_GENERACION"] = document.getElementById('fechaGeneracion')?.value || '';

      // Normalizar delitos elegidos
      let delitoTexto = "";
      if (delitosElegidos.length === 1) {
        delitoTexto = delitosElegidos[0];
      } else if (delitosElegidos.length === 2) {
        delitoTexto = delitosElegidos[0] + " y " + delitosElegidos[1];
      } else if (delitosElegidos.length > 2) {
        delitoTexto = delitosElegidos.slice(0, -1).join(", ") + " y " + delitosElegidos[delitosElegidos.length - 1];
      }
      data["DELITO"] = delitoTexto;

      const abOpt = data["ABOGADO_OPCION"];
      if (abOpt === "DE OFICIO") { data["ABOGADO"] = "de oficio."; }
      else if (abOpt === "OTRO") { data["ABOGADO"] = (data["ABOGADO"] || ""); }
      else { data["ABOGADO"] = data["ABOGADO"] || ""; }

      const ccOpt = data["COMUNICARSE CON_OPCION"];
      if (ccOpt === "NADIE") { data["COMUNICARSE CON:"] = "nadie."; }
      else if (ccOpt === "OTRO") { data["COMUNICARSE CON:"] = (data["COMUNICARSE CON:"] || ""); }
      else { data["COMUNICARSE CON:"] = data["COMUNICARSE CON:"] || ""; }

      const infOpt = data["INFORMAR DE SU DETENCION A_OPCION"] || data["INFORMAR DE SU DETENCION A:"] || "";
      if (infOpt === "NADIE") { data["INFORMAR DE SU DETENCION A:"] = "nadie."; }
      else if (infOpt === "OTRO") { data["INFORMAR DE SU DETENCION A:"] = (data["INFORMAR DE SU DETENCION A:"] || ""); }
      else { data["INFORMAR DE SU DETENCION A:"] = data["INFORMAR DE SU DETENCION A:"] || ""; }

      const intOpt = data["INTERPRETE_OPCION"] || "NO";
      let interpreteDisplay = "NO";

      if (intOpt === "OTRO") {
        interpreteDisplay = data["IDIOMA"] || "";
      } else if (intOpt !== "NO") {
        interpreteDisplay = intOpt;
      }
      data["IDIOMA"] = interpreteDisplay;
      data["INTERPRETE"] = interpreteDisplay;

      const nomDisplay = (data["NOMBRE_PADRES_OPCION"] === "OTRO") ? (data["NOMBRE_PADRES"] || "") : (data["NOMBRE_PADRES_OPCION"] || "");
      const domDisplay = (data["DOMICILIO_OPCION"] === "OTRO") ? (data["DOMICILIO"] || "") : (data["DOMICILIO_OPCION"] || "");
      const telDisplay = (data["TEL√âFONO_OPCION"] === "OTRO") ? (data["TEL√âFONO"] || "") : (data["TEL√âFONO_OPCION"] || "");

      data["MEDICO"] = (data["MEDICO"] === "SI") ? "SI" : "NO";
      data["CONSULADO"] = (data["CONSULADO"] === "SI") ? "SI" : "NO";

      data["NOMBRE_PADRES"] = nomDisplay;
      data["Nombre de los Padres"] = nomDisplay;
      data["DOMICILIO"] = domDisplay;
      data["TEL√âFONO"] = telDisplay;

      // Construir mapa en MAY√öSCULAS para ODT
      const dataUpper = {};
      for (const k in data) {
        dataUpper[k] = U(data[k]);
      }

      const zip = new JSZip();

      // Construir nombre base para carpeta y archivos
      function removeDiacritics(s) {
        return String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/√±/gi, 'n');
      }

      const diligPartRaw = String(data["DILIGENCIAS"] || '').replace(/\//g, '-').trim();
      const delitoPart = String(data["DELITO"] || '').trim();
      const nombrePart = String(data["Nombre"] || '').trim();
      const apellidosPart = String(data["APELLIDOS"] || '').trim();

      let combined = `${diligPartRaw} ${delitoPart} ${nombrePart} ${apellidosPart}`.trim()
        .replace(/_/g, ' ')
        .replace(/\s+/g, ' ');

      combined = removeDiacritics(combined).replace(/[^A-Za-z0-9 \-]/g, '').trim();

      const base = combined.toUpperCase() || "DOCUMENTO";

      // Crear carpeta interna del ZIP
      const folder = zip.folder(base);

      // Calcular edad
      function calcularEdad(fechaStr) {
        const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(fechaStr || "");
        if (!m) return null;
        const dia = parseInt(m[1], 10), mes = parseInt(m[2], 10) - 1, anio = parseInt(m[3], 10);
        const nacimiento = new Date(anio, mes, dia), hoy = new Date();
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const mDiff = hoy.getMonth() - nacimiento.getMonth();
        if (mDiff < 0 || (mDiff === 0 && hoy.getDate() < nacimiento.getDate())) edad--;
        return edad;
      }
      const edad = calcularEdad(data["FECHA DE NACIMIENTO"]);

      // Construir lista de documentos ODT
      let docs = [
        { key: "fax", name: `Fax.odt` },
        { key: "derechos_espanol", name: `derechos_esp.odt` }
      ];

      // Edad ‚Üí amarillas/azules
      if (edad !== null) {
        if (edad >= 18) docs.unshift({ key: "amarillas", name: `amarillas.odt` });
        else docs.unshift({ key: "azules", name: `azules.odt` });
      } else {
        docs.unshift({ key: "azules", name: `azules.odt` });
        docs.unshift({ key: "amarillas", name: `amarillas.odt` });
      }

      // Int√©rprete ‚Üí idioma adicional
      const idiomaSel = (intOpt || "").trim().toUpperCase();
      switch (idiomaSel) {
        case "INGL√âS":
          docs.push({ key: "derechos_ingles", name: `derechos_ing.odt` });
          break;
        case "√ÅRABE":
          docs.push({ key: "derechos_arabe", name: `derechos_arabe.odt` });
          break;
        case "ITALIANO":
          docs.push({ key: "derechos_italiano", name: `derechos_ita.odt` });
          break;
        case "RUSO":
          docs.push({ key: "derechos_ruso", name: `derechos_ruso.odt` });
          break;
        case "OTRO":
          const idiomaOtro = (data["IDIOMA"] || "").trim().toLowerCase();
          if (idiomaOtro) {
            const keyCustom = `derechos_${idiomaOtro}`;
            if (PLANTILLAS[keyCustom]) {
              docs.push({ key: keyCustom, name: `${keyCustom}_${base}.odt` });
            }
          }
          break;
      }

      // Generar ODTs dentro de la carpeta
      let ok = 0;
      for (const d of docs) {
        if (!PLANTILLAS[d.key]) continue;
        const odt = await generarODTUint8(PLANTILLAS[d.key], dataUpper);
        folder.file(d.name, odt, { compression: "STORE" });
        ok++;
      }

      // Generar XLSX de resumen usando funci√≥n com√∫n
      const { filas, excelName } = prepararDatosExcel();
      const xlsx = await generarXLSXUint8(filas, "Resumen");
      folder.file(excelName || `resumen_${base}.xlsx`, xlsx, { compression: "STORE" });

      // Guardar ZIP
      const blob = await zip.generateAsync({ type: "blob", compression: "STORE" });
      await saveBlob(blob, `${base}.zip`);
      msg.innerText = `‚úÖ ZIP generado (${ok} ODT + XLSX)`;
    } catch (err) {
      console.error(err);
      msg.innerText = "‚ùå " + (err?.message || err);
    }
  }

  // Funci√≥n para guardar Blob con File System Access o fallback
  async function saveBlob(blob, filename) {
    if (window.showSaveFilePicker) {
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [{ description: 'Archivo ZIP', accept: { 'application/zip': ['.zip'] } }]
        });
        const writable = await handle.createWritable();
        await writable.write(blob);
        await writable.close();
        return;
      } catch (e) {
        console.warn('FSA fallback', e);
      }
    }
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 1500);
  }

  // C√≥digo para inicializar fecha actual en el input FECHA_GENERACION
  document.addEventListener("DOMContentLoaded", function () {
    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, '0');
    const mes = String(hoy.getMonth() + 1).padStart(2, '0');
    const anio = hoy.getFullYear();
    const fecha = `${dia}/${mes}/${anio}`;

    const inputFecha = document.getElementById("fechaGeneracion");
    if (inputFecha && !inputFecha.value) {
      inputFecha.value = fecha;
    }
  });

  // C√≥digo para manejar selecci√≥n y renderizado de delitos
  const selectDelito = document.getElementById("delitoSelect");
  const lista = document.getElementById("delitosSeleccionados");
  const inputOtro = document.getElementById("delitoOtroTexto");

  selectDelito.addEventListener("change", () => {
    const val = selectDelito.value;

    if (val === "OTRO") {
      inputOtro.style.display = "inline-block";
      inputOtro.focus();
      return;
    }

    if (val && !delitosElegidos.includes(val)) {
      delitosElegidos.push(val);
      renderDelitos();
    }
    selectDelito.value = "";
  });

  inputOtro.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      const val = inputOtro.value.trim();
      if (val && !delitosElegidos.includes(val)) {
        delitosElegidos.push(val);
        renderDelitos();
      }
      inputOtro.value = "";
      inputOtro.style.display = "none";
      selectDelito.value = "";
    }
  });

  function renderDelitos() {
    lista.innerHTML = "";
    if (delitosElegidos.length === 0) {
      lista.innerHTML = "<em>Ning√∫n delito seleccionado</em>";
      return;
    }
    delitosElegidos.forEach((d, i) => {
      const span = document.createElement("span");
      span.textContent = d;
      span.style.cssText = "padding:3px 6px; margin:2px; background:#eef; border:1px solid #99c; border-radius:4px; display:inline-block; cursor:pointer;";
      span.title = "Click para eliminar";
      span.addEventListener("click", () => {
        delitosElegidos.splice(i, 1);
        renderDelitos();
      });
      lista.appendChild(span);
    });
  }
</script>
	<div id="marca-registro">
  103<br>
  JBN<br>
  486
</div>
</body>
</html>


